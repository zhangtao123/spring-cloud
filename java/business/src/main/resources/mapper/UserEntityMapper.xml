<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.anji.allways.business.mapper.UserEntityMapper" >
  <resultMap id="BaseResultMap" type="com.anji.allways.business.entity.UserEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    <id column="id" property="id" jdbcType="INTEGER" />
    <result column="name" property="name" jdbcType="VARCHAR" />
    <result column="account_name" property="accountName" jdbcType="VARCHAR" />
    <result column="password" property="password" jdbcType="VARCHAR" />
    <result column="customer_id" property="customerId" jdbcType="INTEGER" />
    <result column="type" property="type" jdbcType="INTEGER" />
    <result column="is_valid" property="isValid" jdbcType="INTEGER" />
    <result column="locked" property="locked" jdbcType="INTEGER" />
    <result column="description" property="description" jdbcType="VARCHAR" />
    <result column="credentials_salt" property="credentialsSalt" jdbcType="VARCHAR" />
    <result column="create_name" property="createName" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
    <result column="update_user" property="updateUser" jdbcType="VARCHAR" />
    <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
    <result column="reserved" property="reserved" jdbcType="VARCHAR" />
    <result column="permission_user_id" property="permissionUserId" jdbcType="INTEGER" />
    <result column="account_type" property="accountType" jdbcType="INTEGER" />
    <result column="telephone" property="telephone" jdbcType="VARCHAR" />
    <result column="address" property="address" jdbcType="VARCHAR" />
    <result column="customer" property="customer" jdbcType="VARCHAR" />
    <result column="consigneeId" property="consigneeId" jdbcType="INTEGER" />
    <result column="customer_name" property="customerName" jdbcType="VARCHAR" />
    <result column="contactor" property="contactor" jdbcType="VARCHAR" />
    <result column="contactor_mobile" property="contactorMobile" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    id, name, account_name, password, customer_id, type, is_valid, locked, description, 
    credentials_salt, create_name, create_time, update_user, update_time, reserved,permission_user_id,account_type
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    select 
    <include refid="Base_Column_List" />
    from tb_user
    where id = #{id,jdbcType=INTEGER}
  </select>
  <select id="selectByUserName" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from tb_user
    where account_name = #{accountName,jdbcType=VARCHAR}
  </select>
  
  <!-- 通过手机号查询用户信息 -->
  <select id="selectByUserMobile" resultMap="BaseResultMap" parameterType="java.lang.String" >
		SELECT
					u.id,
					u.name,
					u.account_name,
					u.password,
					u.customer_id,
					u.type,
					u.is_valid,
					u.locked,
					u.description,
					u.credentials_salt,
					u.create_name,
					u.create_time,
					u.update_user,
					u.update_time,
					u.reserved,
					u.permission_user_id,
					u.account_type
		FROM
					tb_user_info i,
					tb_user u
		WHERE
			        i.user_id = u.id
	    AND         i.telephone = #{telephone,jdbcType=VARCHAR}
	    order by u.id desc
  </select>
  
  <delete id="deleteByPrimaryKey" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    delete from tb_user
    where id = #{id,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="com.anji.allways.business.entity.UserEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    insert into tb_user (id, name, account_name, 
      password, customer_id, type, 
      is_valid, locked, description, 
      credentials_salt, create_name, create_time, 
      update_user, update_time, reserved,permission_user_id,account_type
      )
    values (#{id,jdbcType=INTEGER}, #{name,jdbcType=VARCHAR}, #{accountName,jdbcType=VARCHAR}, 
      #{password,jdbcType=VARCHAR}, #{customerId,jdbcType=INTEGER}, #{type,jdbcType=INTEGER}, 
      #{isValid,jdbcType=INTEGER}, #{locked,jdbcType=INTEGER}, #{description,jdbcType=VARCHAR}, 
      #{credentialsSalt,jdbcType=VARCHAR}, #{createName,jdbcType=VARCHAR}, #{createTime,jdbcType=TIMESTAMP}, 
      #{updateUser,jdbcType=VARCHAR}, #{updateTime,jdbcType=TIMESTAMP}, #{reserved,jdbcType=VARCHAR},
      #{permissionUserId,jdbcType=INTEGER}, #{accountType,jdbcType=INTEGER}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.anji.allways.business.entity.UserEntity"  useGeneratedKeys="true" keyProperty="id">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    insert into tb_user
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        id,
      </if>
      <if test="name != null" >
        name,
      </if>
      <if test="accountName != null" >
        account_name,
      </if>
      <if test="password != null" >
        password,
      </if>
      <if test="customerId != null" >
        customer_id,
      </if>
      <if test="type != null" >
        type,
      </if>
      <if test="isValid != null" >
        is_valid,
      </if>
      <if test="locked != null" >
        locked,
      </if>
      <if test="description != null" >
        description,
      </if>
      <if test="credentialsSalt != null" >
        credentials_salt,
      </if>
      <if test="createName != null" >
        create_name,
      </if>
      <if test="createTime != null" >
        create_time,
      </if>
      <if test="updateUser != null" >
        update_user,
      </if>
      <if test="updateTime != null" >
        update_time,
      </if>
      <if test="reserved != null" >
        reserved,
      </if>
      <if test="permissionUserId != null" >
        permission_user_id,
      </if>
       <if test="accountType != null" >
        account_type,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="id != null" >
        #{id,jdbcType=INTEGER},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="accountName != null" >
        #{accountName,jdbcType=VARCHAR},
      </if>
      <if test="password != null" >
        #{password,jdbcType=VARCHAR},
      </if>
      <if test="customerId != null" >
        #{customerId,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        #{type,jdbcType=INTEGER},
      </if>
      <if test="isValid != null" >
        #{isValid,jdbcType=INTEGER},
      </if>
      <if test="locked != null" >
        #{locked,jdbcType=INTEGER},
      </if>
      <if test="description != null" >
        #{description,jdbcType=VARCHAR},
      </if>
      <if test="credentialsSalt != null" >
        #{credentialsSalt,jdbcType=VARCHAR},
      </if>
      <if test="createName != null" >
        #{createName,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null" >
        #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null" >
        #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="reserved != null" >
        #{reserved,jdbcType=VARCHAR},
      </if>
      <if test="permissionUserId != null" >
        #{permissionUserId,jdbcType=INTEGER},
      </if>
       <if test="accountType != null" >
        #{accountType,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.anji.allways.business.entity.UserEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    update tb_user
    <trim suffixOverrides="," >
    <set>
      <if test="name != null" >
        name = #{name,jdbcType=VARCHAR},
      </if>
      <if test="accountName != null" >
        account_name = #{accountName,jdbcType=VARCHAR},
      </if>
      <if test="password != null" >
        password = #{password,jdbcType=VARCHAR},
      </if>
      <if test="customerId != null" >
        customer_id = #{customerId,jdbcType=INTEGER},
      </if>
      <if test="type != null" >
        type = #{type,jdbcType=INTEGER},
      </if>
      <if test="isValid != null" >
        is_valid = #{isValid,jdbcType=INTEGER},
      </if>
      <if test="locked != null" >
        locked = #{locked,jdbcType=INTEGER},
      </if>
      <if test="description != null" >
        description = #{description,jdbcType=VARCHAR},
      </if>
      <if test="credentialsSalt != null" >
        credentials_salt = #{credentialsSalt,jdbcType=VARCHAR},
      </if>
      <if test="createName != null" >
        create_name = #{createName,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null" >
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null" >
        update_user = #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null" >
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
      <if test="reserved != null" >
        reserved = #{reserved,jdbcType=VARCHAR},
      </if>
      <if test="permissionUserId != null" >
        permission_user_id = #{permissionUserId,jdbcType=INTEGER},
      </if>
       <if test="accountType != null" >
        account_type = #{accountType,jdbcType=INTEGER},
      </if>
    </set>
    </trim>
    where id = #{id,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.anji.allways.business.entity.UserEntity" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    update tb_user
    set name = #{name,jdbcType=VARCHAR},
      account_name = #{accountName,jdbcType=VARCHAR},
      password = #{password,jdbcType=VARCHAR},
      customer_id = #{customerId,jdbcType=INTEGER},
      type = #{type,jdbcType=INTEGER},
      is_valid = #{isValid,jdbcType=INTEGER},
      locked = #{locked,jdbcType=INTEGER},
      description = #{description,jdbcType=VARCHAR},
      credentials_salt = #{credentialsSalt,jdbcType=VARCHAR},
      create_name = #{createName,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=TIMESTAMP},
      update_user = #{updateUser,jdbcType=VARCHAR},
      update_time = #{updateTime,jdbcType=TIMESTAMP},
      reserved = #{reserved,jdbcType=VARCHAR},
      permission_user_id = #{permissionUserId,jdbcType=INTEGER},
      account_type = #{accountType,jdbcType=INTEGER}
    where id = #{id,jdbcType=INTEGER}
  </update>
  
  <select id="selectUserAndInfo" resultMap="BaseResultMap" parameterType="java.lang.Integer" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    SELECT 
    	a.id,d.name,d.mobile AS telephone,b.address,c.name AS customer,d.id AS consigneeId
    FROM tb_user a
    LEFT JOIN tb_user_info b ON b.user_id=a.id
    LEFT JOIN tb_customer c ON c.id=a.customer_id
    LEFT JOIN tb_consignee d ON d.user_id = a.id
    WHERE a.id = #{id,jdbcType=INTEGER}
  </select>
  
    <!-- 客户账号分页查询 -->
	<select id="queryCustomerAccountInfos" resultMap="BaseResultMap" parameterType="com.anji.allways.business.entity.UserEntity">
		select
		b.id,
		b.customer_id,
		b.account_name,
		b.is_valid,
		b.locked,
		b.account_type,
		b.create_time,
		b.name as contactor,
		a.name as customer_name,
		c.telephone as contactor_mobile
		from tb_warehouse_link_customer twlc
		inner join tb_customer a on
		(a.id=twlc.customer_id)
		inner join tb_user b on
		(b.customer_id=a.id and b.type=1)
		inner join tb_user_info c on
		(c.user_id=b.id)
		where 1=1
		<include refid="Account_Base_Page_Where_List" />
		order by create_time desc
		<if test="dbIndex != null and dbNumber != null">
			limit #{dbIndex},#{dbNumber}
		</if>
	</select>
	<!-- 客户账号分页查询件数查询 -->
	<select id="queryCustomerAccountInfosCount" resultType="java.lang.Integer" parameterType="com.anji.allways.business.entity.UserEntity">
		select
		count(1)
		from tb_warehouse_link_customer twlc
		inner join tb_customer a on
		(a.id=twlc.customer_id)
		inner join tb_user b on
		(b.customer_id=a.id and b.type=1)
		inner join tb_user_info c on
		(c.user_id=b.id)
		where 1=1
		<include refid="Account_Base_Page_Where_List" />
	</select>
	
	<!-- 客户账号分页查询条件 -->
	<sql id="Account_Base_Page_Where_List">
		<if test="accountName != null and accountName != ''">
			and b.account_name like concat("%",#{accountName},"%")
		</if>
		<if test="lockedSearch != null and lockedSearch !=''">
			and b.locked = #{lockedSearch}
		</if>
		<if test="createStartTime != null and createStartTime != ''">
			and date_format(b.create_time,'%Y-%m-%d') >= #{createStartTime}
		</if>
		<if test="createEndTime != null and createEndTime != ''">
			and date_format(b.create_time,'%Y-%m-%d') <![CDATA[<=]]> #{createEndTime}
		</if>
		<if test="createName != null and createName != ''">
			and b.create_name = #{createName}
		</if>
		<if test="contactor != null and contactor != ''">
			and b.name like concat("%",#{contactor},"%")
		</if>
		<if test="contactorMobile != null and contactorMobile != ''">
			and c.telephone like concat("%",#{contactorMobile},"%")
		</if>
		<if test="customerId != null and customerId !=''">
			and a.id = #{customerId}
		</if>
		<if test="customerName != null and customerName !=''">
			and twlc.create_user = #{customerName}
		</if>
		<if test="idList !=null and idList.size>0">
			and twlc.warehouse_id in
			<foreach collection="idList" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
	</sql>
	
	<select id="checkAccountNameByOne" resultType="java.lang.Integer" parameterType="java.util.Map" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Aug 23 17:12:20 CST 2017.
    -->
    SELECT COUNT(*) FROM tb_user a
	LEFT JOIN tb_user_info b ON a.id=b.user_id
	WHERE a.account_name = #{accountName,jdbcType=INTEGER} OR b.telephone=#{telephone,jdbcType=INTEGER}
  </select>

	<!-- 根据客户ID及所属组织查询用户ID -->
	<select id="selectUserIdByCustomerIdAndType" resultType="java.lang.Integer" parameterType="java.util.Map">
		select id from tb_user
		where
		1=1
		<if test="customerId !=null and customerId !='' ">
			and customer_id=#{customerId}
		</if>
		<if test="type !=null and type !='' ">
			and type=#{type}
		</if>
		limit 0,1
	</select>
</mapper>