<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.anji.allways.business.mapper.CustomerEntityMapper">
	<resultMap id="BaseResultMap"
		type="com.anji.allways.business.entity.CustomerEntity">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="short_name" property="shortName" jdbcType="VARCHAR" />
		<result column="parent_id" property="parentId" jdbcType="INTEGER" />
		<result column="group" property="group" jdbcType="VARCHAR" />
		<result column="province_name" property="provinceName"
			jdbcType="VARCHAR" />
		<result column="city_name" property="cityName" jdbcType="VARCHAR" />
		<result column="district_name" property="districtName"
			jdbcType="VARCHAR" />
		<result column="province_code" property="provinceCode"
			jdbcType="VARCHAR" />
		<result column="city_code" property="cityCode" jdbcType="VARCHAR" />
		<result column="district_code" property="districtCode"
			jdbcType="VARCHAR" />
		<result column="address" property="address" jdbcType="VARCHAR" />
		<result column="longitude" property="longitude" jdbcType="REAL" />
		<result column="latitude" property="latitude" jdbcType="REAL" />
		<result column="logo_picture_path" property="logoPicturePath"
			jdbcType="VARCHAR" />
		<result column="contactor" property="contactor" jdbcType="VARCHAR" />
		<result column="contactor_mobile" property="contactorMobile"
			jdbcType="VARCHAR" />
		<result column="ontime_rate" property="ontimeRate" jdbcType="REAL" />
		<result column="comment" property="comment" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="create_user" property="createUser" jdbcType="INTEGER" />
		<result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
		<result column="update_user" property="updateUser" jdbcType="INTEGER" />
		<result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
		<result column="useId" property="useId" jdbcType="INTEGER" />
		<result column="userName" property="userName" jdbcType="VARCHAR" />
		<result column="telephone" property="telephone" jdbcType="VARCHAR" />
		<result column="permission_user_id" property="permissionUserId" jdbcType="INTEGER" />
		<result column="incomeId" property="incomeId" jdbcType="INTEGER" />
		<result column="warehouse_id" property="warehouseId" jdbcType="INTEGER" />
		<result column="group_id" property="groupId" jdbcType="INTEGER" />
	</resultMap>
	
	<resultMap id="BaseResultVOMap" type="com.anji.allways.business.vo.CustomerVO">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="customer_id" property="customerId" jdbcType="INTEGER" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="short_name" property="shortName" jdbcType="VARCHAR" />
		<result column="parent_id" property="parentId" jdbcType="INTEGER" />
		<result column="group" property="group" jdbcType="VARCHAR" />
		<result column="province_name" property="provinceName" jdbcType="VARCHAR" />
		<result column="city_name" property="cityName" jdbcType="VARCHAR" />
		<result column="district_name" property="districtName" jdbcType="VARCHAR" />
		<result column="province_code" property="provinceCode"
			jdbcType="VARCHAR" />
		<result column="city_code" property="cityCode" jdbcType="VARCHAR" />
		<result column="district_code" property="districtCode"
			jdbcType="VARCHAR" />
		<result column="address" property="address" jdbcType="VARCHAR" />
		<result column="longitude" property="longitude" jdbcType="REAL" />
		<result column="latitude" property="latitude" jdbcType="REAL" />
		<result column="logo_picture_path" property="logoPicturePath"
			jdbcType="VARCHAR" />
		<result column="contactor" property="contactor" jdbcType="VARCHAR" />
		<result column="contactor_mobile" property="contactorMobile"
			jdbcType="VARCHAR" />
		<result column="ontime_rate" property="ontimeRate" jdbcType="REAL" />
		<result column="comment" property="comment" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="create_user" property="createUser" jdbcType="INTEGER" />
		<result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
		<result column="update_user" property="updateUser" jdbcType="INTEGER" />
		<result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
		<result column="group_id" property="groupId" jdbcType="INTEGER" />
		<result column="flg" property="flg" jdbcType="VARCHAR" />
		<result column="distance_scope_min" property="distanceScopeMin" jdbcType="INTEGER" />
	    <result column="distance_scope_max" property="distanceScopeMax" jdbcType="INTEGER" />
	    <result column="spend_time" property="spendTime" jdbcType="REAL" />
	</resultMap>
	
	<!-- 返回结果(客户层级查询显示) -->
	<resultMap type="com.anji.allways.business.vo.CustomerLevelVO" id="levelMap">
		<id column="id" property="id" />
		<result column="name" property="text" />
		<result column="parent_id" property="parentId" />
		<collection property="children" column="{parentId=id} "
			ofType="com.anji.allways.business.vo.CustomerLevelVO" select="findLevelChildByParentId"></collection>
	</resultMap>
	
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		id, name, short_name, parent_id,`group`,group_id, province_name, city_name,
		district_name,province_code, city_code, district_code, address,
		longitude,
		latitude, logo_picture_path, contactor, contactor_mobile, ontime_rate, comment,
		status,
		create_user, create_time, update_user, update_time
	</sql>
	
	<!-- 分页查询 -->
	<select id="queryCustomerInfos" resultMap="BaseResultVOMap" parameterType="com.anji.allways.business.entity.CustomerEntity">
		select
		tb_customer.id,
		tb_customer.name,
		tb_customer.short_name,
		tb_customer.parent_id,
		tb_customer.`group`,
		tb_customer.province_name,
		tb_customer.city_name,
		tb_customer.district_name,
		tb_customer.address,
		tb_customer.longitude,
		tb_customer.latitude,
		tb_customer.contactor,
		tb_customer.contactor_mobile,
		tb_customer.status,
		tb_customer.create_time
		from tb_customer
		inner join 
		(select distinct customer_id from tb_warehouse_link_customer
		where 1=1
		<if test="createUser != null and createUser != ''">
			and create_user = #{createUser}
		</if>
		<if test="idList !=null and idList.size>0">
			and warehouse_id in
			<foreach collection="idList" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		)
		 twlc on
		(twlc.customer_id=tb_customer.id)
		where 1=1
		<include refid="Base_Page_Where_List" />
		order by create_time desc
		<if test="dbIndex != null and dbNumber != null">
			limit #{dbIndex},#{dbNumber}
		</if>
	</select>
	<!-- 分页查询件数查询 -->
	<select id="queryCustomerInfosCount" resultType="java.lang.Integer" parameterType="com.anji.allways.business.entity.CustomerEntity">
		select
		count(1)
		from tb_customer
		inner join 
		(select distinct customer_id from tb_warehouse_link_customer
		where 1=1
		<if test="createUser != null and createUser != ''">
			and create_user = #{createUser}
		</if>
		<if test="idList !=null and idList.size>0">
			and warehouse_id in
			<foreach collection="idList" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		)
		 twlc on
		(twlc.customer_id=tb_customer.id)
		where 1=1
		<include refid="Base_Page_Where_List" />
	</select>

	<!-- 分页查询条件 -->
	<sql id="Base_Page_Where_List">
		<if test="name != null and name != ''">
			and (tb_customer.name like concat("%",#{name},"%")
			or tb_customer.short_name like concat("%",#{name},"%") )
		</if>
		<if test="contactor != null and contactor != ''">
			and tb_customer.contactor like concat("%",#{contactor},"%")
		</if>
		<if test="contactorMobile != null and contactorMobile != ''">
			and tb_customer.contactor_mobile like concat("%",#{contactorMobile},"%")
		</if>
		<if test="group != null and group !=''">
			and tb_customer.`group` = #{group}
		</if>
		<if test="groupId != null and groupId !=''">
			and tb_customer.group_id = #{groupId}
		</if>
		<if test="searchStatus != null and searchStatus !=''">
			and tb_customer.status = #{searchStatus}
		</if>
		<if test="createStartTime != null and createStartTime != ''">
			and date_format(tb_customer.create_time,'%Y-%m-%d') >= #{createStartTime}
		</if>
		<if test="createEndTime != null and createEndTime != ''">
			and date_format(tb_customer.create_time,'%Y-%m-%d') <![CDATA[<=]]> #{createEndTime}
		</if>
	</sql>
	
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		select
		<include refid="Base_Column_List" />
		from tb_customer
		where id = #{id,jdbcType=INTEGER}
	</select>
	
	<!-- 查询所有有效客户信息 -->
	<select id="queryAllCustomer" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from tb_customer
		where status = 1
	</select>
	
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		delete from tb_customer
		where id = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.anji.allways.business.entity.CustomerEntity" useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		insert into tb_customer (name, short_name,
		parent_id,`group`,group_id, province_code,
		city_code, district_code,province_name,
		city_name, district_name, address,
		longitude, latitude, logo_picture_path,
		contactor, contactor_mobile, ontime_rate,
		comment, status, create_user,
		create_time, update_user, update_time)
		values (#{name,jdbcType=VARCHAR},
		#{shortName,jdbcType=VARCHAR},
		#{parentId,jdbcType=INTEGER}, #{group,jdbcType=VARCHAR},
		#{groupId,jdbcType=INTEGER}, 
		#{provinceCode,jdbcType=VARCHAR},
		#{cityCode,jdbcType=VARCHAR},
		#{districtCode,jdbcType=VARCHAR},#{provinceName,jdbcType=VARCHAR},
		#{cityName,jdbcType=VARCHAR}, #{districtName,jdbcType=VARCHAR},
		#{address,jdbcType=VARCHAR},
		#{longitude,jdbcType=REAL}, #{latitude,jdbcType=REAL}, #{logoPicturePath,jdbcType=VARCHAR},
		#{contactor,jdbcType=VARCHAR}, #{contactorMobile,jdbcType=VARCHAR},
		#{ontimeRate,jdbcType=REAL},
		#{comment,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER}, #{createUser,jdbcType=INTEGER},
		#{createTime,jdbcType=TIMESTAMP}, #{updateUser,jdbcType=INTEGER},
		#{updateTime,jdbcType=TIMESTAMP}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.anji.allways.business.entity.CustomerEntity" useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		insert into tb_customer
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="name != null">
				name,
			</if>
			<if test="shortName != null">
				short_name,
			</if>
			<if test="parentId != null">
				parent_id,
			</if>
			<if test="group != null">
				`group`,
			</if>
			<if test="groupId != null">
				group_id,
			</if>
			<if test="province_code != null">
				province_code,
			</if>
			<if test="city_code != null">
				city_code,
			</if>
			<if test="district_code != null">
				district_code,
			</if>
			<if test="province_name != null">
				province_name,
			</if>
			<if test="city_name != null">
				city_name,
			</if>
			<if test="district_name != null">
				district_name,
			</if>
			<if test="address != null">
				address,
			</if>
			<if test="longitude != null">
				longitude,
			</if>
			<if test="latitude != null">
				latitude,
			</if>
			<if test="logoPicturePath != null">
				logo_picture_path,
			</if>
			<if test="contactor != null">
				contactor,
			</if>
			<if test="contactorMobile != null">
				contactor_mobile,
			</if>
			<if test="ontimeRate != null">
				ontime_rate,
			</if>
			<if test="comment != null">
				comment,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="createUser != null">
				create_user,
			</if>
			<if test="createTime != null">
				create_time,
			</if>
			<if test="updateUser != null">
				update_user,
			</if>
			<if test="updateTime != null">
				update_time,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="name != null">
				#{name,jdbcType=VARCHAR},
			</if>
			<if test="shortName != null">
				#{shortName,jdbcType=VARCHAR},
			</if>
			<if test="parentId != null">
				#{parentId,jdbcType=INTEGER},
			</if>
			<if test="group != null">
				#{group,jdbcType=VARCHAR},
			</if>
			<if test="groupId != null">
				#{groupId,jdbcType=INTEGER},
			</if>
			<if test="province_code != null">
				#{provinceCode,jdbcType=VARCHAR},
			</if>
			<if test="city_code != null">
				#{cityCode,jdbcType=VARCHAR},
			</if>
			<if test="district_code != null">
				#{districtCode,jdbcType=VARCHAR},
			</if>
			<if test="province_name != null">
				#{provinceName,jdbcType=VARCHAR},
			</if>
			<if test="city_name != null">
				#{cityName,jdbcType=VARCHAR},
			</if>
			<if test="district_name != null">
				#{districtName,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				#{address,jdbcType=VARCHAR},
			</if>
			<if test="longitude != null">
				#{longitude,jdbcType=REAL},
			</if>
			<if test="latitude != null">
				#{latitude,jdbcType=REAL},
			</if>
			<if test="logoPicturePath != null">
				#{logoPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="contactor != null">
				#{contactor,jdbcType=VARCHAR},
			</if>
			<if test="contactorMobile != null">
				#{contactorMobile,jdbcType=VARCHAR},
			</if>
			<if test="ontimeRate != null">
				#{ontimeRate,jdbcType=REAL},
			</if>
			<if test="comment != null">
				#{comment,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				#{status,jdbcType=INTEGER},
			</if>
			<if test="createUser != null">
				#{createUser,jdbcType=INTEGER},
			</if>
			<if test="createTime != null">
				#{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="updateUser != null">
				#{updateUser,jdbcType=INTEGER},
			</if>
			<if test="updateTime != null">
				#{updateTime,jdbcType=TIMESTAMP},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.anji.allways.business.entity.CustomerEntity">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		update tb_customer
		<set>
		  <trim suffixOverrides=",">
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="shortName != null">
				short_name = #{shortName,jdbcType=VARCHAR},
			</if>
			<if test="parentId != null">
				parent_id = #{parentId,jdbcType=INTEGER},
			</if>
			<if test="group != null">
				`group` = #{group,jdbcType=VARCHAR},
			</if>
			<if test="groupId != null">
				group_id = #{groupId,jdbcType=INTEGER},
			</if>
			<if test="province_code != null">
				province_code = #{provinceCode,jdbcType=VARCHAR},
			</if>
			<if test="city_code != null">
				city_code = #{cityCode,jdbcType=VARCHAR},
			</if>
			<if test="district_code != null">
				district_code = #{districtCode,jdbcType=VARCHAR},
			</if>
			<if test="province_name != null">
				province_name = #{provinceName,jdbcType=VARCHAR},
			</if>
			<if test="city_name != null">
				city_name = #{cityName,jdbcType=VARCHAR},
			</if>
			<if test="district_name != null">
				district_name = #{districtName,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="longitude != null">
				longitude = #{longitude,jdbcType=REAL},
			</if>
			<if test="latitude != null">
				latitude = #{latitude,jdbcType=REAL},
			</if>
			<if test="logoPicturePath != null">
				logo_picture_path = #{logoPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="contactor != null">
				contactor = #{contactor,jdbcType=VARCHAR},
			</if>
			<if test="contactorMobile != null">
				contactor_mobile = #{contactorMobile,jdbcType=VARCHAR},
			</if>
			<if test="ontimeRate != null">
				ontime_rate = #{ontimeRate,jdbcType=REAL},
			</if>
			<if test="comment != null">
				comment = #{comment,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=INTEGER},
			</if>
			<if test="createUser != null">
				create_user = #{createUser,jdbcType=INTEGER},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="updateUser != null">
				update_user = #{updateUser,jdbcType=INTEGER},
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime,jdbcType=TIMESTAMP},
			</if>
		  </trim>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.anji.allways.business.entity.CustomerEntity">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		update tb_customer
		set name = #{name,jdbcType=VARCHAR},
		short_name = #{shortName,jdbcType=VARCHAR},
		parent_id = #{parentId,jdbcType=INTEGER},
		`group` = #{group,jdbcType=VARCHAR},
		group_id = #{groupId,jdbcType=INTEGER},
		province_code = #{provinceCode,jdbcType=VARCHAR},
		city_code = #{cityCode,jdbcType=VARCHAR},
		district_code = #{districtCode,jdbcType=VARCHAR},
		province_name = #{provinceName,jdbcType=VARCHAR},
		city_name = #{cityName,jdbcType=VARCHAR},
		district_name = #{districtName,jdbcType=VARCHAR},
		address = #{address,jdbcType=VARCHAR},
		longitude = #{longitude,jdbcType=REAL},
		latitude = #{latitude,jdbcType=REAL},
		logo_picture_path = #{logoPicturePath,jdbcType=VARCHAR},
		contactor = #{contactor,jdbcType=VARCHAR},
		contactor_mobile = #{contactorMobile,jdbcType=VARCHAR},
		ontime_rate = #{ontimeRate,jdbcType=REAL},
		comment = #{comment,jdbcType=VARCHAR},
		status = #{status,jdbcType=INTEGER},
		create_user = #{createUser,jdbcType=INTEGER},
		create_time = #{createTime,jdbcType=TIMESTAMP},
		update_user = #{updateUser,jdbcType=INTEGER},
		update_time = #{updateTime,jdbcType=TIMESTAMP}
		where id = #{id,jdbcType=INTEGER}
	</update>
	
	<!-- 分页查询(编辑库容页面使用) -->
	<select id="queryCustomerInfosForStorage" resultMap="BaseResultVOMap"
		parameterType="java.util.Map">
		SELECT
			id,
			id as customer_id,
			NAME,
			short_name,
			contactor,
			contactor_mobile,
			CASE
		WHEN id IN (
			SELECT
				customer_id
			FROM
				tb_warehouse_link_customer
			WHERE
				warehouse_id = #{warehouseId}
		) THEN
			0
		WHEN id IN (
			SELECT
				customer_id
			FROM
				tb_user
			WHERE
				locked = 1
		) THEN
			0
		ELSE
			1
		END AS flg
		FROM
			tb_customer
		where 1=1
		<include refid="Base_Where_List" />
		order by create_time desc
		<if test="dbIndex != null and dbNumber != null">
			limit #{dbIndex},#{dbNumber}
		</if>
	</select>
	<!-- 分页查询件数查询(编辑库容页面使用) -->
	<select id="queryCustomerInfosCountForStorage" resultType="java.lang.Integer"
		parameterType="java.util.Map">
		select
		count(1)
		from tb_customer
		where 1=1
		<include refid="Base_Where_List" />
	</select>

	<!-- 分页查询条件 -->
	<sql id="Base_Where_List">
		<if test="name != null and name != ''">
			and (tb_customer.name like concat("%",#{name},"%")
			or tb_customer.short_name like concat("%",#{name},"%") )
		</if>
		<if test="contactorMobile != null and contactorMobile != ''">
			and tb_customer.contactor_mobile like concat("%",#{contactorMobile},"%")
		</if>
	</sql>
	
	<!-- 分页查询件数查询(编辑库容页面使用) -->
	<select id="queryCustomerInfoByUserId" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		select
		a.*
		from tb_customer a
		LEFT JOIN tb_user b ON b.customer_id = a.id
		where b.id = #{id,jdbcType=INTEGER}
		ORDER BY a.create_time DESC
	</select>
	
	<!-- 查询本公司人信息 -->
	<select id="queryCompanyCustomerByUserId" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
	    SELECT a.id, b.id AS useId, a.name,d.name AS userName,d.mobile AS telephone,a.province_name,a.city_name,a.district_name,a.address,b.permission_user_id,d.id AS incomeId FROM tb_customer a
		LEFT JOIN tb_user b ON a.id=b.customer_id
		INNER JOIN tb_consignee d ON d.user_id = b.id
		LEFT JOIN tb_user_info c ON c.user_id=b.id
		WHERE a.parent_id =(SELECT cu.parent_id FROM tb_customer cu
		LEFT JOIN tb_user us ON cu.id=us.customer_id
		WHERE us.id = #{userId,jdbcType=INTEGER})
		ORDER BY a.create_time DESC
	</select>
	
	<!-- 查询本公司人信息 -->
	<select id="queryGroupCustomerByUserId" resultMap="BaseResultMap"
		parameterType="java.util.Map">
		SELECT a.id, b.id AS useId, a.name,d.name AS userName,d.mobile AS telephone,a.province_name,a.city_name,a.district_name,a.address,b.permission_user_id,d.id AS incomeId FROM tb_customer a
		LEFT JOIN tb_user b ON a.id=b.customer_id
		INNER JOIN tb_consignee d ON d.user_id = b.id
		LEFT JOIN tb_user_info c ON c.user_id=b.id
		WHERE a.group_id =(SELECT group_id FROM tb_customer WHERE id =(SELECT customer_id FROM tb_user WHERE id= #{userId,jdbcType=INTEGER}))
		<if test="name != null and name != ''">
			and e.name like concat("%",#{name},"%")
		</if>
		ORDER BY a.create_time DESC
	</select>
	
	<!-- 上一级客户查询-->
	<select id="selectCustomerLevelInfor" resultMap="levelMap" parameterType="java.util.Map">
		SELECT
		DISTINCT 
		a.id,
		a.name,
		a.short_name,
		a.parent_id
		from 
		(select distinct customer_id from tb_warehouse_link_customer
		where 1=1
		<if test="createUser != null and createUser != ''">
			and create_user = #{createUser}
		</if>
		<if test="idList !=null and idList.size>0">
			and warehouse_id in
			<foreach collection="idList" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
		) twlc
		inner join tb_customer a on
		(a.id=twlc.customer_id)
		WHERE
		a.status = 1
		<!-- 一级客户的上级客户ID为0 -->
		<if test="parentId == null and (name ==null or name =='')">
			and a.parent_id=0
		</if>
		<if test="parentId != null and parentId !=''">
			and a.id=#{parentId}
		</if>
		<if test="name !=null and name !=''">
			and (a.name like concat("%",#{name},"%")
			or a.short_name like concat("%",#{name},"%"))
		</if>
	</select>
	<!-- 下级客户查询 -->
	<select id="findLevelChildByParentId" resultMap="levelMap" parameterType="java.util.Map">
		SELECT 
		b.id,
		b.name,
		b.short_name,
		b.parent_id 
		FROM
		tb_customer b
		WHERE b.parent_id=#{parentId}
		and b.status = 1
	</select>
	
	 <!-- 获取所属集团信息下拉列表 -->
	 <select id="queryGroupForDict" resultType="com.anji.allways.business.vo.DictVO" parameterType="java.util.Map" >
		select 
		distinct 
		tcg.id as code,
		tcg.name as name
		from tb_customer_group tcg
		where tcg.status =1
		<if test="name != null and name != ''">
			and (tcg.name like concat("%",#{name},"%")
			or tcg.short_name like concat("%",#{name},"%"))
		</if>
	 </select>
	 
	 <!-- 批量激活或停用客户 -->
	<update id="updateByIdList" parameterType="java.util.Map">
		update tb_customer
		set status = #{status,jdbcType=INTEGER},
		update_user = #{userId,jdbcType=INTEGER},
		update_time = current_timestamp()
		where
		status <![CDATA[<>]]>
		#{status,jdbcType=INTEGER}
		and id in
		<foreach collection="idList" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
	</update>
	
	<!-- 校验客户是否存在已入库的入库计划单且未完成的运输订单 -->
    <select id="checkCustomerStatus" resultType="java.lang.String" parameterType="java.util.Map" >
	    select 
	    distinct t.name
	    from tb_customer t
	    inner join tb_storage_plan t1 on
	    (t1.customer_id = t.id and
	    t1.status = 1)
	    inner join tb_order t2 on
	    (t2.customer_id = t.id and
	    t2.status <![CDATA[<>]]> 5)
	    where 
	    t.status = 1
	    and t.id in
	    <foreach collection="idList" index="index" item="item" open="(" separator="," close=")">
	        #{item}
	    </foreach>
    </select>
    
    <!-- 根据ID获取客户信息 -->
	<select id="selectInfoById" resultMap="BaseResultVOMap" parameterType="java.lang.Integer">
		select
		a.id,
		a.name,
		a.short_name,
		a.parent_id,
		a.`group`,
		a.group_id,
		a.province_code,
		a.city_code,
		a.district_code,
		a.address,
		a.longitude,
		a.latitude,
		a.logo_picture_path,
		a.contactor,
		a.contactor_mobile,
		a.status,
		a.create_time
		from tb_customer a
		where a.id = #{id,jdbcType=INTEGER}
	</select>
	
	<!-- 值重复check -->
	<select id="checkRepeatValue" resultType="java.lang.Integer" parameterType="java.util.Map">
		select
		count(1)
		from tb_customer
		where 1=1
		<if test="id != null and id !=''">
			and id <![CDATA[<>]]> #{id}
		</if>
		<if test="name != null and name !=''">
			and name = #{name,jdbcType=VARCHAR}
		</if>
		<if test="shortName != null and shortName !=''">
			and short_name = #{shortName,jdbcType=VARCHAR}
		</if>
	</select>
	
	<update id="updateInfoByID" parameterType="com.anji.allways.business.entity.CustomerEntity">
		update tb_customer
		<set>
		   <trim suffixOverrides=",">
			<if test="name != null">
				name = #{name,jdbcType=VARCHAR},
			</if>
			<if test="shortName != null">
				short_name = #{shortName,jdbcType=VARCHAR},
			</if>
			<if test="parentId != null">
				parent_id = #{parentId,jdbcType=INTEGER},
			</if>
			<if test="group != null">
				`group` = #{group,jdbcType=VARCHAR},
			</if>
			<if test="groupId != null">
				group_id = #{groupId,jdbcType=INTEGER},
			</if>
			<if test="province_code != null">
				province_code = #{provinceCode,jdbcType=VARCHAR},
			</if>
			<if test="city_code != null">
				city_code = #{cityCode,jdbcType=VARCHAR},
			</if>
			<if test="district_code != null">
				district_code = #{districtCode,jdbcType=VARCHAR},
			</if>
			<if test="province_name != null">
				province_name = #{provinceName,jdbcType=VARCHAR},
			</if>
			<if test="city_name != null">
				city_name = #{cityName,jdbcType=VARCHAR},
			</if>
			<if test="district_name != null">
				district_name = #{districtName,jdbcType=VARCHAR},
			</if>
			<if test="address != null">
				address = #{address,jdbcType=VARCHAR},
			</if>
			<if test="longitude != null">
				longitude = #{longitude,jdbcType=REAL},
			</if>
			<if test="latitude != null">
				latitude = #{latitude,jdbcType=REAL},
			</if>
			<if test="logoPicturePath != null">
				logo_picture_path = #{logoPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="contactor != null">
				contactor = #{contactor,jdbcType=VARCHAR},
			</if>
			<if test="contactorMobile != null">
				contactor_mobile = #{contactorMobile,jdbcType=VARCHAR},
			</if>
			<if test="comment != null">
				comment = #{comment,jdbcType=VARCHAR},
			</if>
			<if test="updateUser != null">
				update_user = #{updateUser,jdbcType=INTEGER},
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime,jdbcType=TIMESTAMP},
			</if>
		  </trim>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>
	
	<!-- 获取所属客户信息下拉列表 -->
	 <select id="queryCustomerForDict" resultType="com.anji.allways.business.vo.DictVO" parameterType="java.util.Map" >
		select 
		distinct
		tb_customer.id as code, 
		tb_customer.name as name
		from tb_warehouse_link_customer twlc
		inner join tb_customer on
		(tb_customer.id=twlc.customer_id)
		where tb_customer.status =1
		<if test="name != null and name != ''">
			and tb_customer.name like concat("%",#{name},"%")
		</if>
		<if test="createUser != null and createUser != ''">
			and tb_customer.create_user = #{createUser}
		</if>
		<if test="idList !=null and idList.size>0">
			and twlc.warehouse_id in
			<foreach collection="idList" index="index" item="item" open="("
				separator="," close=")">
				#{item}
			</foreach>
		</if>
	 </select>
	 
	 <!-- 值重复check -->
	<select id="selectCustomerByWarehouse" resultMap="BaseResultMap" parameterType="java.lang.Integer">
		SELECT a.*,c.id AS warehouse_id FROM tb_customer a
		LEFT JOIN tb_warehouse_link_customer b ON a.id=b.customer_id
		LEFT JOIN tb_warehouse c ON c.id = b.warehouse_id
		LEFT JOIN tb_user d ON d.customer_id = c.id
		WHERE d.id = #{userId,jdbcType=INTEGER}
	</select>

	<!-- 根据集团查客户 -->
	<select id="selectCustomerByGroupId" resultType="java.util.Map" parameterType="java.lang.Integer">
		SELECT MAX(b.id) AS id,a.name FROM tb_customer a
		LEFT JOIN tb_user b ON a.id = b.customer_id
		WHERE a.group_id = (SELECT customer_id FROM tb_user WHERE id=#{userId,jdbcType=INTEGER})
		GROUP BY a.name
	</select>

	<!-- 根据集团查客户 -->
	<select id="selectGroupNameByUserId" resultType="java.lang.String" parameterType="java.lang.Integer">
		SELECT MAX(b.id) AS id,a.name FROM tb_customer a
		LEFT JOIN tb_user b ON a.id = b.customer_id
		WHERE a.group_id = (SELECT customer_id FROM tb_user WHERE id=#{userId,jdbcType=INTEGER})
		GROUP BY a.name
	</select>

	<!-- 查询经销商名称-->
	<select id="selectCustomerNameByUserId" resultType="java.lang.String" parameterType="java.lang.Integer">
		SELECT a.name FROM tb_customer a
		LEFT JOIN tb_user b ON a.id = b.customer_id
		WHERE b.id=#{userId,jdbcType=INTEGER}
	</select>
</mapper>