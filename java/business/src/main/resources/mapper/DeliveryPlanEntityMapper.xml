<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.anji.allways.business.mapper.DeliveryPlanEntityMapper">
	<resultMap id="BaseResultMap" type="com.anji.allways.business.dto.DeliveryPlanDTO">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="no" property="no" jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="INTEGER" />
		<result column="parent_id" property="parentId" jdbcType="INTEGER" />
		<result column="delivery_type" property="deliveryType"
			jdbcType="VARCHAR" />
		<result column="delivery_plan_time" property="deliveryPlanTime"
			jdbcType="TIMESTAMP" />
		<result column="pickup_plan_time" property="pickupPlanTime"
			jdbcType="TIMESTAMP" />
		<result column="transport_type" property="transportType"
			jdbcType="VARCHAR" />
		<result column="warehouse_name" property="warehouseName"
			jdbcType="VARCHAR" />
		<result column="driver_id" property="driverId" jdbcType="INTEGER" />
		<result column="delivery_time" property="deliveryTime"
			jdbcType="TIMESTAMP" />
		<result column="consignee_id" property="consigneeId" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="status_name" property="statusName" jdbcType="VARCHAR" />
		<result column="create_time" property="createTime" jdbcType="TIMESTAMP" />
		<result column="customer" property="customer" jdbcType="VARCHAR" />
		<result column="operator" property="operator" jdbcType="VARCHAR" />
		<result column="ship_no" property="shipNo" jdbcType="VARCHAR" />
		<result column="identity_card_picture_path" property="identityCardPicturePath"
			jdbcType="VARCHAR" />
		<result column="identity_card_picture_number" property="identityCardPictureNumber"
			jdbcType="INTEGER" />
		<result column="identity_card_status" property="identityCardStatus"
			jdbcType="INTEGER" />
		<result column="check_comment" property="checkComment"
			jdbcType="VARCHAR" />
		<result column="selfpicker_picture_path" property="selfpickerPicturePath"
			jdbcType="VARCHAR" />
		<result column="selfpicker_picture_number" property="selfpickerPictureNumber"
			jdbcType="INTEGER" />
		<result column="is_void" property="isVoid" jdbcType="INTEGER" />
		<result column="create_user" property="createUser" jdbcType="INTEGER" />
		<result column="update_user" property="updateUser" jdbcType="INTEGER" />
		<result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
		<result column="reserved" property="reserved" jdbcType="VARCHAR" />
		<result column="warehouse_id" property="warehouseId" jdbcType="INTEGER" />
		<result column="routing_status" property="routingStatus"
			jdbcType="INTEGER" />
		<result column="truck_number" property="truckNumber" jdbcType="VARCHAR" />
		<result column="vehicleCount" property="vehicleCount" jdbcType="INTEGER" />
		<result column="transport_company_name" property="transportCompanyName"
			jdbcType="VARCHAR" />
		<result column="customerName" property="customerName" jdbcType="VARCHAR" />
		<result column="incomeName" property="incomeName" jdbcType="VARCHAR" />
		<result column="contactor_mobile" property="contactorMobile"
			jdbcType="VARCHAR" />
		<result column="province_name" property="provinceName"
			jdbcType="VARCHAR" /><result column="city_name" property="cityName" jdbcType="VARCHAR" />
		<result column="district_name" property="districtName"
			jdbcType="VARCHAR" />
		<result column="address" property="address" jdbcType="VARCHAR" />
		<result column="truck_number" property="truckNumber" jdbcType="VARCHAR" />
		<result column="driverName" property="driverName" jdbcType="VARCHAR" />
		<result column="driverMobile" property="driverMobile" jdbcType="VARCHAR" />
		<result column="despatch_confirm_picture_path" property="despatchConfirmPicturePath" jdbcType="VARCHAR" />
		<result column="despatch_confirm_picture_number" property="despatchConfirmPictureNumber" jdbcType="INTEGER" />
        <result column="keyIsTaken" property="keyIsTaken" jdbcType="INTEGER" />
        <result column="accept_comment" property="acceptComment" jdbcType="VARCHAR" />
        <result column="create_time_show" property="createTimeShow" jdbcType="VARCHAR" />
        <result column="telephone" property="telephone" jdbcType="VARCHAR" />
	</resultMap>


	<resultMap id="truckResultMap"
		type="com.anji.allways.business.entity.TruckDriverEntity">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="transport_company_name" property="transportCompanyName"
			jdbcType="VARCHAR" />
		<result column="truck_number" property="truckNumber" jdbcType="VARCHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="mobile" property="mobile" jdbcType="VARCHAR" />
	</resultMap>


	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		id, no, type, parent_id, delivery_type, delivery_plan_time,
		pickup_plan_time, transport_type,
		warehouse_name, driver_id,
		delivery_time, consignee_id, status, create_time,
		customer, operator,
		ship_no, identity_card_picture_path,
		identity_card_picture_number,
		identity_card_status, check_comment, selfpicker_picture_path,
		selfpicker_picture_number,
		is_void, create_user, update_user,
		update_time,keyIsTaken,
		reserved,warehouse_id,routing_status,despatch_confirm_picture_path,
		despatch_confirm_picture_number,accept_comment
	</sql>

	<!-- 返回结果集(根据仓库ID获取库容信息) -->
	<resultMap id="deliveryPlanVOMap" type="com.anji.allways.business.vo.DeliveryPlanVO">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="no" property="no" jdbcType="VARCHAR" />
		<result column="type" property="type" jdbcType="INTEGER" />
		<result column="warehouse_name" property="warehouseName"
			jdbcType="VARCHAR" />
		<result column="warehouse_address" property="warehouseAddress"
			jdbcType="VARCHAR" />
		<result column="create_user_mobile" property="createUserMobile"
			jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="province_name" property="provinceName"
			jdbcType="VARCHAR" />
		<result column="city_name" property="cityName" jdbcType="VARCHAR" />
		<result column="district_name" property="districtName"
			jdbcType="VARCHAR" />
		<collection property="childList" column="{parentId=id} "
			ofType="com.anji.allways.business.vo.DeliveryPlanChildVO" select="findChildDeliveryPlanByParentId">
			<id column="id" property="id" />
			<result column="no" property="no" jdbcType="VARCHAR" />
			<result column="status" property="status" jdbcType="INTEGER" />
			<result column="routing_status" property="routingStatus"
				jdbcType="INTEGER" />
			<result column="customer" property="customer" jdbcType="VARCHAR" />
			<result column="consignee_name" property="consigneeName"
				jdbcType="VARCHAR" />
			<result column="consignee_mobile" property="consigneeMobile"
				jdbcType="VARCHAR" />
			<result column="consignee_address" property="consigneeAddress"
				jdbcType="VARCHAR" />
			<result column="consignee_user_id" property="consigneeUserId"
				jdbcType="INTEGER" />
		</collection>
	</resultMap>
	<resultMap id="deliveryPlanCarVOMap" type="com.anji.allways.business.vo.VehicleVO">
		<id column="id" property="id" />
		<result column="order_no" property="orderNo" jdbcType="VARCHAR" />
		<result column="order_id" property="orderId" jdbcType="INTEGER" />
		<result column="vin" property="vin" jdbcType="VARCHAR" />
		<result column="brand" property="brand" jdbcType="VARCHAR" />
		<result column="series" property="series" jdbcType="VARCHAR" />
		<result column="model" property="model" jdbcType="VARCHAR" />
		<result column="announce_year" property="announceYear" jdbcType="VARCHAR" />
		<result column="standard_color_name" property="standardColorName"
			jdbcType="VARCHAR" />
		<result column="standard_color_path" property="standardColorPath"
			jdbcType="VARCHAR" />
		<result column="manufacturer_color" property="manufacturerColor"
			jdbcType="VARCHAR" />
		<result column="picture_path" property="picturePath" jdbcType="VARCHAR" />
		<result column="picture_number" property="pictureNumber"
			jdbcType="INTEGER" />
		<result column="vehicle_status" property="vehicleStatus"
			jdbcType="INTEGER" />
	</resultMap>

	<!-- 返回结果集(根据出库计划ID获取库容信息) -->
	<resultMap id="deliveryPlanDetailMap" type="com.anji.allways.business.vo.DeliveryPlanVO">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="parent_id" property="parentId" jdbcType="INTEGER" />
		<result column="no" property="no" jdbcType="VARCHAR" />
		<result column="delivery_type" property="deliveryType" jdbcType="VARCHAR" />
		<result column="warehouse_name" property="warehouseName" jdbcType="VARCHAR" />
		<result column="pickup_plan_time" property="pickupPlanTime" jdbcType="VARCHAR" />
		<result column="consignee_mobile" property="consigneeMobile" jdbcType="VARCHAR" />
		<result column="transport_type" property="transportType" jdbcType="VARCHAR" />
		<result column="delivery_plan_time" property="deliveryPlanTime" jdbcType="VARCHAR" />
		<result column="customer" property="customer" jdbcType="VARCHAR" />
		<result column="transport_company_name" property="transportCompanyName" jdbcType="VARCHAR" />
		<result column="transport_type" property="transportType" jdbcType="VARCHAR" />
		<result column="truck_number" property="truckNumber" jdbcType="VARCHAR" />
		<result column="driver_mobile" property="driverMobile" jdbcType="VARCHAR" />
		<result column="driver_name" property="driverName" jdbcType="VARCHAR" />
		<result column="ship_no" property="shipNo" jdbcType="VARCHAR" />
		<result column="customer" property="customer" jdbcType="VARCHAR" />
		<result column="identity_card_picture_path" property="identityCardPicturePath" jdbcType="VARCHAR" />
		<result column="identity_card_status" property="identityCardStatus" jdbcType="INTEGER" />
		<result column="consignee_mobile" property="consigneeMobile" jdbcType="VARCHAR" />
		<result column="delivery_time" property="deliveryTime" jdbcType="VARCHAR" />
		<result column="consignee_name" property="consigneeName" jdbcType="VARCHAR" />
		<result column="despatch_confirm_picture_path" property="despatchConfirmPicturePath" jdbcType="VARCHAR" />
		<result column="despatch_confirm_picture_number" property="despatchConfirmPictureNumber" jdbcType="INTEGER" />
		<result column="is_printed" property="isPrinted" jdbcType="INTEGER" />
		<collection property="orderList" column="delivery_plan_id=id"
			javaType="ArrayList" ofType="com.anji.allways.business.vo.OrderVO"
			select="selectDeliveryPlanOrderList">
		</collection>
	</resultMap>
	
	<!-- 返回结果集(根据出库计划ID获取库容信息) (发运) -->
	<resultMap id="deliveryPlanDetailMapFY" type="com.anji.allways.business.vo.DestinationVO">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="destination" property="destination" jdbcType="VARCHAR" />
		<result column="car_sum" property="carSum" jdbcType="VARCHAR" />
		<result column="name" property="name" jdbcType="VARCHAR" />
		<result column="mobile" property="mobile" jdbcType="VARCHAR" />
		<result column="delivery_time" property="deliveryTime" jdbcType="TIMESTAMP" />
		<result column="keyIsTaken" property="keyIsTaken" jdbcType="INTEGER" />
		<result column="despatch_confirm_picture_path" property="despatchConfirmPicturePath" jdbcType="VARCHAR" />
		<result column="accept_comment" property="acceptComment" jdbcType="VARCHAR" />
		<result column="receive_time" property="receiveTime" jdbcType="TIMESTAMP" />
		<result column="ship_no" property="shipNo" jdbcType="INTEGER" />
		<collection property="orderList" column="delivery_plan_id=id"
			javaType="ArrayList" ofType="com.anji.allways.business.vo.OrderVO"
			select="selectDeliveryPlanOrderList">
		</collection>
	</resultMap>
	<!-- 返回结果集(根据出库计划ID获取库容信息)（计划单下的订单列表） -->
	<resultMap id="orderResultMap" type="com.anji.allways.business.vo.OrderVO">
		<id column="id" property="id" jdbcType="INTEGER" />
		<result column="vin" property="vin" jdbcType="VARCHAR" />
		<result column="no" property="no" jdbcType="VARCHAR" />
		<result column="destination" property="destination" jdbcType="VARCHAR" />
		<result column="customer" property="customer" jdbcType="VARCHAR" />
		<result column="location" property="location" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="create_time" property="createTime" jdbcType="VARCHAR" />
		<result column="pickup_self_time" property="pickupSelfTime" jdbcType="VARCHAR" />
		<result column="receive_time" property="receiveTime" jdbcType="VARCHAR" />
		<result column="consignee_id" property="consigneeId" jdbcType="INTEGER" />
		<result column="customer_id" property="customerId" jdbcType="INTEGER" />
		<result column="vehicle_id" property="vehicleId" jdbcType="INTEGER" />
	</resultMap>
	
	<!-- 子出库计划单送达车辆信息 -->
	<resultMap id="deliveryPlanChildVOMap" type="com.anji.allways.business.vo.DeliveryPlanChildVO">
		<id column="id" property="id" />
		<result column="no" property="no" jdbcType="VARCHAR" />
		<result column="status" property="status" jdbcType="INTEGER" />
		<result column="routing_status" property="routingStatus" jdbcType="INTEGER" />
		<result column="customer" property="customer" jdbcType="VARCHAR" />
		<result column="consignee_name" property="consigneeName" jdbcType="VARCHAR" />
		<result column="consignee_mobile" property="consigneeMobile" jdbcType="VARCHAR" />
		<result column="consignee_address" property="consigneeAddress" jdbcType="VARCHAR" />
		<result column="car_num" property="carNum" jdbcType="INTEGER" />
	</resultMap>
	
	
	
	
	<!-- 发运出库计划单打印 -->
	<resultMap id="deliveryPlanVOMapPrintFy" type="com.anji.allways.business.vo.DeliveryPlanVO">
		<id column="id" property="id" />
		<result column="no" property="no" jdbcType="VARCHAR" />
		<result column="ship_no" property="shipNo" jdbcType="INTEGER" />
		<result column="delivery_time" property="deliveryTime" jdbcType="TIMESTAMP" />
		<result column="transport_company_name" property="transportCompanyName" jdbcType="VARCHAR" />
		<result column="truck_number" property="truckNumber" jdbcType="VARCHAR" />
		<result column="driver_name" property="driverName" jdbcType="VARCHAR" />
		<result column="destination" property="destination" jdbcType="VARCHAR" />
		<result column="customer" property="customer" jdbcType="VARCHAR" />
		<result column="consignee_name" property="consigneeName" jdbcType="VARCHAR" />
		<result column="consignee_mobile" property="consigneeMobile" jdbcType="VARCHAR" />
		<collection property="orderList" column="delivery_plan_id=id"
			javaType="ArrayList" ofType="com.anji.allways.business.vo.OrderVO"
			select="selectDeliveryPlanOrderList">
		</collection>
	</resultMap>
	
	
	
	<sql id="Base_Where_List" >
		<!-- 子订单标识 -->
		<if test="no != null and no != ''">
			and  plan.no like concat("%",#{no},"%")
		</if>
		<if test="truckNumber != null and truckNumber != ''">
			and  driver.truck_number like concat("%",#{truckNumber},"%")
		</if>
		<if test="createStartTime != null and createStartTime != ''">
			and date_format( plan.create_time,'%Y-%m-%d') <![CDATA[>=]]>#{createStartTime}
		</if>
		<if test="createEndTime != null and createEndTime != ''">
			and date_format( plan.create_time,'%Y-%m-%d') <![CDATA[<=]]>#{createEndTime}
		</if>
		<if test="shipNo != null and shipNo != ''">
			and plan.ship_no like concat("%",#{shipNo},"%")
		</if>
		<if test="transportType != null and transportType != ''">
			and  plan.transport_type = #{transportType}
		</if>
		<if test="status != null and status != ''">
			and  plan.status = #{status}
		</if>
		<if test="deliveryTimeStart != null and deliveryTimeStart != ''">
			and date_format( plan.delivery_time,'%Y-%m-%d') <![CDATA[>=]]>#{deliveryTimeStart}
		</if>
		<if test="deliveryTimeEnd != null and deliveryTimeEnd != ''">
			and date_format( plan.delivery_time,'%Y-%m-%d') <![CDATA[<=]]>#{deliveryTimeEnd}
		</if>
		<if test="pickupPlanTimeStart != null and pickupPlanTimeStart != ''">
			and date_format( plan.pickup_plan_time,'%Y-%m-%d') <![CDATA[>=]]>#{pickupPlanTimeStart}
		</if>
		<if test="pickupPlanTimeEnd != null and pickupPlanTimeEnd != ''">
			and date_format( plan.pickup_plan_time,'%Y-%m-%d') <![CDATA[<=]]>#{pickupPlanTimeEnd}
		</if>
		<!-- 登录人是管理员根据仓库id进行权限过滤查询 -->
		<if test="idList !=null and idList.size>0">
			and  plan.warehouse_id in
			<foreach collection="idList" index="index" item="item" open="("
			separator="," close=")">
			#{item}
		</foreach>
		</if>
		<if test="createUser !=null and createUser !='' ">
			 and plan.create_user = #{create_user}
	    </if>
	    <if test="warehouseName !=null and warehouseName !='' ">
			 and plan.warehouse_name like concat("%",#{warehouseName},"%")
	    </if>    
	</sql>
	

	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		select
		<include refid="Base_Column_List" />
		from tb_delivery_plan
		where id = #{id,jdbcType=INTEGER}
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Integer">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		delete from tb_delivery_plan
		where id = #{id,jdbcType=INTEGER}
	</delete>
	<insert id="insert" parameterType="com.anji.allways.business.entity.DeliveryPlanEntity">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		insert into tb_delivery_plan (id, no, type, parent_id,delivery_type,
		delivery_plan_time, pickup_plan_time,
		transport_type, warehouse_name,
		driver_id,
		delivery_time, consignee_id, status,
		create_time, customer,
		operator,
		ship_no, identity_card_picture_path,
		identity_card_picture_number,
		identity_card_status, check_comment,
		selfpicker_picture_path,
		selfpicker_picture_number, is_void,
		create_user,
		update_user, update_time,
		reserved,warehouse_id,routing_status,
		despatch_confirm_picture_path,
		despatch_confirm_picture_number,
		accept_comment
		)
		values (#{id,jdbcType=INTEGER},
		#{no,jdbcType=VARCHAR},
		#{type,jdbcType=INTEGER},
		#{parentId,jdbcType=INTEGER},
		#{deliveryType,jdbcType=VARCHAR},
		#{deliveryPlanTime,jdbcType=TIMESTAMP},
		#{pickupPlanTime,jdbcType=TIMESTAMP},
		#{transportType,jdbcType=VARCHAR}, #{warehouseName,jdbcType=VARCHAR},
		#{driverId,jdbcType=VARCHAR},#{deliveryTime,jdbcType=TIMESTAMP},
		#{consigneeId,jdbcType=VARCHAR}, #{status,jdbcType=INTEGER},
		#{createTime,jdbcType=TIMESTAMP}, #{customer,jdbcType=VARCHAR},
		#{operator,jdbcType=VARCHAR},
		#{shipNo,jdbcType=VARCHAR},
		#{identityCardPicturePath,jdbcType=VARCHAR},
		#{identityCardPictureNumber,jdbcType=INTEGER},
		#{identityCardStatus,jdbcType=INTEGER},
		#{checkComment,jdbcType=VARCHAR},
		#{selfpickerPicturePath,jdbcType=VARCHAR},
		#{selfpickerPictureNumber,jdbcType=INTEGER},
		#{isVoid,jdbcType=INTEGER}, #{createUser,jdbcType=INTEGER},
		#{updateUser,jdbcType=INTEGER}, #{updateTime,jdbcType=TIMESTAMP},
		#{reserved,jdbcType=VARCHAR},#{warehouseId,jdbcType=INTEGER}
		,#{routingStatus,jdbcType=INTEGER},#{despatchConfirmPicturePath,jdbcType=VARCHAR}
		,#{despatchConfirmPictureNumber,jdbcType=INTEGER}
		,#{acceptComment,jdbcType=VARCHAR}
		)
	</insert>
	<insert id="insertSelective" parameterType="com.anji.allways.business.entity.DeliveryPlanEntity">
		<selectKey resultType="java.lang.Integer" order="AFTER"  keyProperty="id">
	      SELECT LAST_INSERT_ID()
	    </selectKey>
		insert into tb_delivery_plan
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="no != null">
				no,
			</if>
			<if test="type != null">
				type,
			</if>
			<if test="parentId != null">
				parent_id,
			</if>
			<if test="deliveryType != null">
				delivery_type,
			</if>
			<if test="deliveryPlanTime != null">
				delivery_plan_time,
			</if>
			<if test="pickupPlanTime != null">
				pickup_plan_time,
			</if>
			<if test="transportType != null">
				transport_type,
			</if>
			<if test="warehouseName != null">
				warehouse_name,
			</if>
			<if test="driverId != null">
				driver_id,
			</if>
			<if test="deliveryTime != null">
				delivery_time,
			</if>
			<if test="consigneeId != null">
				consignee_id,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="createTime != null">
				create_time,
			</if>
			<if test="customer != null">
				customer,
			</if>
			<if test="operator != null">
				operator,
			</if>
			<if test="shipNo != null">
				ship_no,
			</if>
			<if test="identityCardPicturePath != null">
				identity_card_picture_path,
			</if>
			<if test="identityCardPictureNumber != null">
				identity_card_picture_number,
			</if>
			<if test="identityCardStatus != null">
				identity_card_status,
			</if>
			<if test="checkComment != null">
				check_comment,
			</if>
			<if test="selfpickerPicturePath != null">
				selfpicker_picture_path,
			</if>
			<if test="selfpickerPictureNumber != null">
				selfpicker_picture_number,
			</if>
			<if test="isVoid != null">
				is_void,
			</if>
			<if test="createUser != null">
				create_user,
			</if>
			<if test="updateUser != null">
				update_user,
			</if>
			<if test="updateTime != null">
				update_time,
			</if>
			<if test="reserved != null">
				reserved,
			</if>
			<if test="warehouseId != null">
				warehouse_id,
			</if>
			<if test="routingStatus != null">
				routing_status,
			</if>
			<if test="despatchConfirmPicturePath != null">
				despatch_confirm_picture_path,
			</if>
			<if test="despatchConfirmPictureNumber != null">
				despatch_confirm_picture_number,
			</if>
            <if test="keyIsTaken != null">
				keyIsTaken,
			</if>
			<if test="acceptComment != null">
				accept_comment,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="no != null">
				#{no,jdbcType=VARCHAR},
			</if>
			<if test="type != null">
				#{type,jdbcType=INTEGER},
			</if>
			<if test="parentId != null">
				#{parentId,jdbcType=INTEGER},
			</if>
			<if test="deliveryType != null">
				#{deliveryType,jdbcType=VARCHAR},
			</if>
			<if test="deliveryPlanTime != null">
				#{deliveryPlanTime,jdbcType=TIMESTAMP},
			</if>
			<if test="pickupPlanTime != null">
				#{pickupPlanTime,jdbcType=TIMESTAMP},
			</if>
			<if test="transportType != null">
				#{transportType,jdbcType=VARCHAR},
			</if>
			<if test="warehouseName != null">
				#{warehouseName,jdbcType=VARCHAR},
			</if>
			<if test="driverId != null">
				#{driverId,jdbcType=VARCHAR},
			</if>
			<if test="deliveryTime != null">
				#{deliveryTime,jdbcType=TIMESTAMP},
			</if>
			<if test="consigneeId != null">
				#{consigneeId,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				#{status,jdbcType=INTEGER},
			</if>
			<if test="createTime != null">
				#{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="customer != null">
				#{customer,jdbcType=VARCHAR},
			</if>
			<if test="operator != null">
				#{operator,jdbcType=VARCHAR},
			</if>
			<if test="shipNo != null">
				#{shipNo,jdbcType=VARCHAR},
			</if>
			<if test="identityCardPicturePath != null">
				#{identityCardPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="identityCardPictureNumber != null">
				#{identityCardPictureNumber,jdbcType=INTEGER},
			</if>
			<if test="identityCardStatus != null">
				#{identityCardStatus,jdbcType=INTEGER},
			</if>
			<if test="checkComment != null">
				#{checkComment,jdbcType=VARCHAR},
			</if>
			<if test="selfpickerPicturePath != null">
				#{selfpickerPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="selfpickerPictureNumber != null">
				#{selfpickerPictureNumber,jdbcType=INTEGER},
			</if>
			<if test="isVoid != null">
				#{isVoid,jdbcType=INTEGER},
			</if>
			<if test="createUser != null">
				#{createUser,jdbcType=INTEGER},
			</if>
			<if test="updateUser != null">
				#{updateUser,jdbcType=INTEGER},
			</if>
			<if test="updateTime != null">
				#{updateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="reserved != null">
				#{reserved,jdbcType=VARCHAR},
			</if>
			<if test="warehouseId != null">
				#{warehouseId,jdbcType=INTEGER},
			</if>
			<if test="routingStatus != null">
				#{routingStatus,jdbcType=INTEGER},
			</if>
			<if test="despatchConfirmPicturePath != null">
				#{despatchConfirmPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="despatchConfirmPictureNumber != null">
				#{despatchConfirmPictureNumber,jdbcType=INTEGER},
			</if>
			<if test="keyIsTaken != null">
				#{keyIsTaken,jdbcType=INTEGER},
			</if>
			<if test="acceptComment != null">
				#{acceptComment,jdbcType=VARCHAR},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.anji.allways.business.entity.DeliveryPlanEntity">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		update tb_delivery_plan
		<set>
		<trim suffixOverrides=",">
			<if test="no != null">
				no = #{no,jdbcType=VARCHAR},
			</if>
			<if test="type != null">
				type = #{type,jdbcType=INTEGER},
			</if>
			<if test="parentId != null">
				parent_id = #{parentId,jdbcType=INTEGER},
			</if>
			<if test="deliveryType != null">
				delivery_type = #{deliveryType,jdbcType=VARCHAR},
			</if>
			<if test="deliveryPlanTime != null">
			delivery_plan_time =
				#{deliveryPlanTime,jdbcType=TIMESTAMP},
			</if>
			<if test="pickupPlanTime != null">
				pickup_plan_time = #{pickupPlanTime,jdbcType=TIMESTAMP},
			</if>
			<if test="transportType != null">
				transport_type = #{transportType,jdbcType=VARCHAR},
			</if>
			<if test="warehouseName != null">
				warehouse_name = #{warehouseName,jdbcType=VARCHAR},
			</if>
			<if test="driverId != null">
				driver_id = #{driverId,jdbcType=VARCHAR},
			</if>
			<if test="deliveryTime != null">
				delivery_time = #{deliveryTime,jdbcType=TIMESTAMP},
			</if>
			<if test="consigneeId != null">
				consignee_id = #{consigneeId,jdbcType=VARCHAR},
			</if>
			<if test="status != null">
				status = #{status,jdbcType=INTEGER},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=TIMESTAMP},
			</if>
			<if test="customer != null">
				customer = #{customer,jdbcType=VARCHAR},
			</if>
			<if test="operator != null">
				operator = #{operator,jdbcType=VARCHAR},
			</if>
			<if test="shipNo != null">
				ship_no = #{shipNo,jdbcType=VARCHAR},
			</if>
			<if test="identityCardPicturePath != null">
				identity_card_picture_path =
				#{identityCardPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="identityCardPictureNumber != null">
				identity_card_picture_number =
				#{identityCardPictureNumber,jdbcType=INTEGER},
			</if>
			<if test="identityCardStatus != null">
				identity_card_status =
				#{identityCardStatus,jdbcType=INTEGER},
			</if>
			<if test="checkComment != null">
				check_comment = #{checkComment,jdbcType=VARCHAR},
			</if>
			<if test="selfpickerPicturePath != null">
				selfpicker_picture_path =
				#{selfpickerPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="selfpickerPictureNumber != null">
				selfpicker_picture_number =
				#{selfpickerPictureNumber,jdbcType=INTEGER},
			</if>
			<if test="isVoid != null">
				is_void = #{isVoid,jdbcType=INTEGER},
			</if>
			<if test="createUser != null">
				create_user = #{createUser,jdbcType=INTEGER},
			</if>
			<if test="updateUser != null">
				update_user = #{updateUser,jdbcType=INTEGER},
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime,jdbcType=TIMESTAMP},
			</if>
			<if test="reserved != null">
				reserved = #{reserved,jdbcType=VARCHAR},
			</if>
			<if test="reserved != null">
				warehouse_id = #{warehouseId,jdbcType=INTEGER},
			</if>
			<if test="routingStatus != null">
				routing_status = #{routingStatus,jdbcType=INTEGER},
			</if>
			<if test="despatchConfirmPicturePath != null">
				despatch_confirm_picture_path = #{despatchConfirmPicturePath,jdbcType=VARCHAR},
			</if>
			<if test="despatchConfirmPictureNumber != null">
				despatch_confirm_picture_number = #{despatchConfirmPictureNumber,jdbcType=INTEGER},
			</if>
			<if test="keyIsTaken != null">
				keyIsTaken = #{keyIsTaken,jdbcType=INTEGER},
		    </if>
		    <if test="acceptComment != null">
				accept_comment = #{acceptComment,jdbcType=VARCHAR},
			</if>
		</trim>
		</set>
		where id = #{id,jdbcType=INTEGER}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.anji.allways.business.entity.DeliveryPlanEntity">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Wed Aug 23 
			17:12:20 CST 2017. -->
		update tb_delivery_plan
		set no = #{no,jdbcType=VARCHAR},type =
		#{type,jdbcType=INTEGER},
		parent_id = #{parentId,jdbcType=INTEGER},
		delivery_type = #{deliveryType,jdbcType=VARCHAR},
		delivery_plan_time =
		#{deliveryPlanTime,jdbcType=TIMESTAMP},
		pickup_plan_time =
		#{pickupPlanTime,jdbcType=TIMESTAMP},
		transport_type =
		#{transportType,jdbcType=VARCHAR},
		warehouse_name =
		#{warehouseName,jdbcType=VARCHAR},
		driver_id =
		#{driverId,jdbcType=VARCHAR},
		delivery_time =
		#{deliveryTime,jdbcType=TIMESTAMP},
		consignee_id =
		#{consigneeId,jdbcType=VARCHAR},
		status = #{status,jdbcType=INTEGER},
		create_time = #{createTime,jdbcType=TIMESTAMP},
		customer =
		#{customer,jdbcType=VARCHAR},
		operator = #{operator,jdbcType=VARCHAR},
		ship_no = #{shipNo,jdbcType=VARCHAR},
		identity_card_picture_path =
		#{identityCardPicturePath,jdbcType=VARCHAR},
		identity_card_picture_number =
		#{identityCardPictureNumber,jdbcType=INTEGER},
		identity_card_status =
		#{identityCardStatus,jdbcType=INTEGER},
		check_comment =
		#{checkComment,jdbcType=VARCHAR},
		selfpicker_picture_path =
		#{selfpickerPicturePath,jdbcType=VARCHAR},
		selfpicker_picture_number =
		#{selfpickerPictureNumber,jdbcType=INTEGER},
		is_void =
		#{isVoid,jdbcType=INTEGER},
		create_user =
		#{createUser,jdbcType=INTEGER},
		update_user =
		#{updateUser,jdbcType=INTEGER},
		update_time =
		#{updateTime,jdbcType=TIMESTAMP},
		reserved =
		#{reserved,jdbcType=VARCHAR},
		warehouse_id =
		#{warehouseId,jdbcType=INTEGER},
		routing_status =
		#{routingStatus,jdbcType=INTEGER},
		despatch_confirm_picture_path = #{despatchConfirmPicturePath,jdbcType=VARCHAR},
		despatch_confirm_picture_number = #{despatchConfirmPictureNumber,jdbcType=INTEGER},
		keyIsTaken =#{keyIsTaken,jdbcType=INTEGER},
		accept_comment = #{acceptComment,jdbcType=VARCHAR}
		where id = #{id,jdbcType=INTEGER}
	</update>

	<!-- 查询出库计划单总数 -->
	<select id="selectDeliveryPlanCount" parameterType="com.anji.allways.business.dto.DeliveryPlanDTO"
		resultType="java.lang.Integer">
		select count(1) 
		from tb_delivery_plan plan left join tb_truck_driver driver
		on plan.driver_id = driver.mobile
		where 1=1
		<if test="type != null">
			and plan.type = #{type}
		</if>
		<include refid="Base_Where_List"/>
	</select>
	
	
	

	<!-- 查询出库计划单信息列表 -->
	<select id="selectDeliveryPlan" parameterType="com.anji.allways.business.dto.DeliveryPlanDTO"
		resultMap="BaseResultMap">
		select
			plan.id,
			plan.NO,
			plan.create_time,
			plan.warehouse_name,
			plan.pickup_plan_time,
			plan.delivery_plan_time,
			plan.delivery_time,
			plan.ship_no,
			plan.operator,
			plan.identity_card_status,
			plan.keyIsTaken,
			plan.STATUS,
			plan.transport_type,
			driver. NAME driverName,
			driver.mobile driverMobile,
			driver.transport_company_name,
			driver.truck_number,
			(
			SELECT
				count(1)
			FROM
				tb_order o
			WHERE
			    <if test=' transportType=="发运" '>
	     			o.delivery_plan_id in (SELECT plan1.id FROM tb_delivery_plan plan1 WHERE plan1.parent_id = plan.id)
	     		</if>
	     		<if test=' transportType=="自提" '>
	     			o.delivery_plan_id = plan.id
	     		</if>
			) carsNum,
			(
			SELECT
				count(1)
			FROM
				tb_order o
			WHERE
			    <if test=' transportType=="发运" '>
	     			o.delivery_plan_id in (SELECT plan1.id FROM tb_delivery_plan plan1 WHERE plan1.parent_id = plan.id) AND o.status =3
	     		</if>
	     		<if test=' transportType=="自提" '>
	     			o.delivery_plan_id = plan.id and o.status =2
	     		</if>
			) outNum,
			plan.delivery_type
		from tb_delivery_plan plan left join tb_truck_driver driver
		on plan.driver_id = driver.id
		where 1=1
		<if test="type != null">
			and plan.type = #{type}
		</if>
		<include refid="Base_Where_List"/>
		order by plan.create_time DESC
   </select>
  
  
    <!-- 根据登录人id获取仓库名 -->
  <select id="selectWareHouseNameByUserId" resultMap="BaseResultMap" parameterType="java.lang.String" >
  		SELECT
			name as warehouse_name,
			id AS warehouse_id
		FROM
			tb_warehouse w
		JOIN (
			SELECT
				customer_id
			FROM
				tb_user
			WHERE
				id = #{userId,jdbcType=VARCHAR}
			AND type = 2
		) u ON w.id = u.customer_id
		ORDER BY w.create_time desc
		limit 0,1
  </select>



	<!-- 根据手机号获取司机信息 -->
	<select id="selectDriverByMobile" resultMap="truckResultMap"
		parameterType="java.lang.String">
		select
		transport_company_name,
		truck_number,
		name,
		id,
		mobile
		from tb_truck_driver
		where mobile = #{mobile,jdbcType=VARCHAR}
		AND status = 1
		limit 0,1
	</select>


	<!-- 父出库计划单查询 -->
	<select id="selectInfoById" resultMap="deliveryPlanVOMap"
		parameterType="java.lang.Integer">
		SELECT
		a.id,
		a.no,
		a.type,
		a.status,
		b.name as warehouse_name,
		b.province_name,
		b.city_name,
		b.district_name,
		b.address as warehouse_address,
		c.telephone as create_user_mobile
		FROM tb_delivery_plan a
		inner join tb_warehouse b on
		(b.id=a.warehouse_id)
		inner join tb_user_info c
		on
		(c.user_id=a.create_user)
		WHERE
		a.id=#{id}
		and a.type=0
	</select>
	<!-- 子出库计划单查询 -->
	<select id="findChildDeliveryPlanByParentId" resultType="com.anji.allways.business.vo.DeliveryPlanChildVO"
		parameterType="java.util.Map">
		SELECT
		T.id,
		T.no,
		T.status,
		T.routing_status,
		T.customer,
		T2.name as consignee_name,
		T2.mobile as consignee_mobile,
		T2.user_id as consignee_user_id,
		(select DISTINCT T1.destination from
		tb_order T1 where T1.delivery_plan_id=T.id) as consignee_address
		FROM
		tb_delivery_plan T
		inner join tb_consignee T2 on
		(T2.id=T.consignee_id)
		WHERE
		T.parent_id=#{parentId} and T.type=1
		ORDER BY T.create_time DESC
	</select>
	<!-- 根据子出库计划单ID查询车辆信息 -->
	<select id="findCarByDeliveryPlanNo" resultMap="deliveryPlanCarVOMap"
		parameterType="java.util.Map">
		SELECT
		T.id,
		T.vin,
		T.brand,
		T.series,
		T.model,
		T.announce_year,
		T.manufacturer_color,
		T.picture_path,
		T.picture_number,
		T.vehicle_status,
		tb_order.id as order_id,
		tb_order.no as order_no,
		T1.dict_key as standard_color_name,
		T1.dict_value as standard_color_path
		FROM
		tb_order
		inner join tb_vehicle T
		on
		(T.id=tb_order.vehicle_id)
		left join tb_dict
		T1 on
		(T1.id=T.standard_color_id)
		WHERE
		tb_order.delivery_plan_id=#{deliveryPlanId}
		order by tb_order.create_time desc
	</select>

	<!-- 查询出库计划详情信息（自提） -->
	<select id="selectDeliveryPlanInfoByIdZT" resultMap="deliveryPlanDetailMap"
		parameterType="java.lang.Integer">
		SELECT
			plan.id,
			plan.NO,
			plan.transport_type,
			plan.warehouse_name,
			plan.pickup_plan_time,
			con.NAME consignee_name,
			con.mobile consignee_mobile,
			plan.ship_no,
			plan.identity_card_picture_path,
			plan.selfpicker_picture_path,
			plan.status,
			plan.identity_card_status,
			plan.delivery_time,
			plan.keyIsTaken,
			pt.is_printed
		FROM
			tb_delivery_plan plan
			LEFT JOIN tb_consignee con ON plan.consignee_id = con.id
			LEFT JOIN tb_ship_receipt pt ON plan.ship_no = pt.no
		WHERE plan.id = #{id};
	</select>
	<!-- 查询出库计划详情订单信息（出库计划关联的订单列表） -->
	<select id="selectDeliveryPlanOrderList" resultMap="orderResultMap"
		parameterType="java.util.Map">
		SELECT
			o.id,
			o.vin,
			o.NO,
			o.destination,
			o.customer,
			o.location,
			o.receive_time,
			o.create_time,
			o.pickup_self_time,
			o.STATUS,
			o.consignee_id,
			o.customer_id,
			ve.brand,
			ve.model,
			IFNULL(ve.manufacturer_color,ve.standard_color_id) vehicleColor,
			o.vehicle_id
			<!-- (CASE WHEN (STATUS = 4 OR STATUS = 7 OR STATUS = 9) AND date_add(delivery_time,INTERVAL 6 HOUR) <![CDATA[<]]>  NOW() THEN
				8
			 ELSE
				STATUS
			END
			 ) status -->
			FROM
			tb_order o INNER JOIN tb_vehicle ve ON o.vehicle_id = ve.id
		WHERE
			delivery_plan_id = #{delivery_plan_id}
	    order by create_time desc
	</select>

	<!-- 查询出库计划详情订单信息 （发运） -->
	<select id="selectDeliveryPlanInfoByIdFY" resultMap="deliveryPlanDetailMapFY"
		parameterType="java.lang.Integer">
		SELECT
			t.destination,
			t.car_sum,
			nee.NAME,
			nee.mobile,
			t.delivery_time,
			t.id,
		    t.keyIsTaken,
		    t.despatch_confirm_picture_path,
		    t.accept_comment,
		    t.receive_time,
		    t.ship_no,
		    t.is_printed
		FROM
			(
				SELECT
					count(1) car_sum,
					ord.customer_id,
					ord.destination,
					ord.consignee_id,
					any_value (plan.delivery_time) delivery_time,
					any_value (plan.id) id,
					any_value(keyIsTaken) keyIsTaken,
					any_value(plan.despatch_confirm_picture_path) despatch_confirm_picture_path,
					any_value(plan.accept_comment) accept_comment,
					max(ord.receive_time) receive_time,
					any_value(plan.ship_no) ship_no,
					any_value(pt.is_printed) is_printed
					
				FROM
				(
				SELECT id,delivery_time,keyIsTaken,despatch_confirm_picture_path,accept_comment,ship_no
				FROM
				tb_delivery_plan
				WHERE
				id = #{id}
				) plan
			LEFT JOIN tb_order ord ON plan.id = ord.delivery_plan_id 
			LEFT JOIN tb_ship_receipt pt ON plan.ship_no = pt.no
			GROUP BY ord.customer_id,ord.destination,ord.consignee_id
		) t
		LEFT JOIN tb_consignee nee ON t.consignee_id = nee.id
	</select>

	<!-- 查询子出库计划 -->
	<select id="selectDeliveryPlanSub" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		select id,no,ship_no from tb_delivery_plan 
		where 
			parent_id =#{id} 
			and type = 1 
			and status != 6
		order by create_time desc
	</select>


	<!-- 查询父出库计划 -->
	<select id="selectDeliveryPlanPar" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		SELECT
			plan.id,
			plan.NO,
			plan.type,
			plan.parent_id,
			plan.delivery_type,
			plan.delivery_plan_time,
			plan.pickup_plan_time,
			plan.transport_type,
			plan.warehouse_name,
			plan.driver_id,
			plan.delivery_time,
			plan.consignee_id,
			plan.STATUS,
			plan.create_time,
			plan.customer,
			plan.ship_no,
			plan.identity_card_picture_path,
			plan.identity_card_picture_number,
			plan.identity_card_status,
			plan.check_comment,
			plan.selfpicker_picture_path,
			plan.selfpicker_picture_number,
			plan.create_user,
			plan.update_user,
			plan.update_time,
			plan.keyIsTaken,
			plan.warehouse_id,
			plan.despatch_confirm_picture_path,
			plan.despatch_confirm_picture_number,
			plan.accept_comment,
			driver.mobile driverMobile,
			driver.NAME driverName,
			driver.transport_company_name,
			driver.truck_number
		FROM
			tb_delivery_plan plan
		INNER JOIN tb_truck_driver driver ON plan.driver_id = driver.id
		WHERE
			plan.id = #{id} 
			and plan.type = 0 
			and plan.status != 6
		order by plan.create_time desc
	</select>

	<!-- 查询父出库计划 -->
	<select id="selectIncomeVehicleCount" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM tb_delivery_plan a
		WHERE
		a.transport_type=#{transportType,jdbcType=VARCHAR} AND
		a.consignee_id=(SELECT id FROM tb_consignee WHERE user_id=#{userId,jdbcType=INTEGER}) AND a.type=1
		<if test="type != null and type==0">
			AND	a.status IN (2,3,4)
		</if>
		<if test="type != null and type==1">
			AND	a.status IN (5,6)
		</if>
	</select>

	<!-- 查询父出库计划 -->
	<select id="selectIncomeVehicle" resultMap="BaseResultMap">
		SELECT
		a.id,a.warehouse_name,a.no,a.delivery_plan_time,a.pickup_plan_time,a.transport_type,a.status,(SELECT
		COUNT(0) FROM tb_order b
		LEFT JOIN tb_vehicle v ON b.vehicle_id=v.id
		WHERE b.delivery_plan_id=a.id) AS
		vehicleCount,c.transport_company_name FROM tb_delivery_plan a
		LEFT JOIN
		tb_truck_driver c ON a.driver_id=c.id
		WHERE
		a.transport_type=#{transportType,jdbcType=VARCHAR} AND
		a.consignee_id=(SELECT id FROM tb_consignee WHERE user_id=#{userId,jdbcType=INTEGER}) AND a.type=1
		<if test="type != null and type ==0">
			AND	a.status IN (2,3,4)
		</if>
		<if test="type != null and type ==1">
			AND	a.status IN (5,6)
		</if>
		ORDER BY a.create_time DESC
		LIMIT
		#{pageIndex,jdbcType=INTEGER},#{pageNumber,jdbcType=INTEGER}
	</select>

	<!-- 经销商收车查询详情 -->
	<select id="incomeDetialForward" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		SELECT a.id,a.create_time,a.status,c.id AS consignee_id,b.name AS customerName,g.name AS
		incomeName,g.mobile AS contactor_mobile,f.address,a.warehouse_name,a.no,a.delivery_plan_time,a.pickup_plan_time,
		a.ship_no,a.transport_type,d.transport_company_name,d.truck_number,d.name
		AS driverName,d.mobile AS driverMobile,a.delivery_type,e.contactor_mobile AS telephone,a.routing_status,
		a.identity_card_picture_path,a.identity_card_status,a.selfpicker_picture_path,a.driver_id
		FROM tb_delivery_plan a
		LEFT JOIN tb_consignee g ON g.id = a.consignee_id
		LEFT JOIN tb_user c ON c.id=g.user_id
		LEFT JOIN tb_user_info f ON f.user_id = c.id
		LEFT JOIN tb_customer b ON c.customer_id=b.id
		LEFT JOIN tb_truck_driver d ON d.id=a.driver_id
		LEFT JOIN tb_warehouse e ON a.warehouse_id = e.id
		WHERE a.id=#{deliveryId,jdbcType=INTEGER}
	</select>

	<!-- 查询出库计划单下的运输单列表（编辑页面）（自提） -->
	<select id="selectDeliveryPlanOrdersForEditZt" parameterType="java.lang.Integer"
		resultMap="deliveryPlanDetailMap">
		SELECT
		plan.id,
		plan.NO,
		plan.delivery_type,
		plan.warehouse_name,
		plan.pickup_plan_time,
		plan.customer,
		con.name
		consignee_name,
		con.mobile consignee_mobile
		FROM
		tb_delivery_plan plan
		LEFT JOIN tb_consignee con ON plan.consignee_id = con.id
		WHERE plan.id = #{id}
	</select>

	<!-- 查询出库计划单下的运输单列表（编辑页面）（发运） -->
	<select id="selectDeliveryPlanOrdersForEditFy" parameterType="java.lang.Integer"
		resultMap="deliveryPlanDetailMap">
		SELECT
			plan.id,
			plan.parent_id,
			plan.NO,
			plan.delivery_plan_time,
			plan.delivery_type,
			plan.transport_type,
			plan.warehouse_name,
			driver.transport_company_name,
			driver.truck_number,
			driver.NAME driver_name,
			driver.mobile driver_mobile
		FROM
			tb_delivery_plan plan
		LEFT JOIN tb_truck_driver driver ON plan.driver_id = driver.id
		WHERE plan.id = #{id}

	</select>
	<!-- 取消父出库计划 -->
	<select id="checkDriver" resultType="java.lang.Integer">
		SELECT id FROM tb_user a	
		WHERE a.customer_id=(	
		SELECT driver_id FROM tb_delivery_plan b WHERE b.id = #{deliveryId,jdbcType=INTEGER}) AND TYPE=4 LIMIT 1
	</select>
	
	<!-- 确认送达更新操作 -->
	<update id="updateForConfirmArrive" parameterType="java.util.Map">
		update tb_delivery_plan set 
		routing_status = #{routingStatus,jdbcType=INTEGER},
		despatch_confirm_picture_path=#{despatchConfirmPicturePath},
		despatch_confirm_picture_number=#{despatchConfirmPictureNumber},
		accept_comment=#{acceptComment},
		update_user=#{userId},
		update_time=current_timestamp()
		where 
		id = #{id,jdbcType=INTEGER}
	</update>
	
	<!-- 子出库计划单送达车辆信息 -->
	<select id="findChildDeliveryPlanByChildId" resultMap="deliveryPlanChildVOMap"
		parameterType="java.util.Map">
		SELECT
			T.id,
			T.NO,
			T.STATUS,
			T.routing_status,
			T.customer,
			count(T3.id) AS car_num
		FROM
			tb_delivery_plan T
		INNER JOIN tb_order T3 ON (T3.delivery_plan_id = T.id)
		WHERE
		T.id=#{id} and T.type=1
		GROUP BY 
		T.ID
	</select>
	
	<!-- 司机查询出库计划 -->
	<select id="driverDeliveryPlan" resultMap="BaseResultMap">
		SELECT a.id,a.no,a.delivery_plan_time,a.warehouse_name,a.status,(SELECT
		COUNT(1) FROM tb_order b
		LEFT JOIN tb_vehicle d ON b.vehicle_id=d.id
		WHERE b.delivery_plan_id IN (SELECT c.id FROM tb_delivery_plan c
		WHERE c.parent_id=a.id)) AS
		vehicleCount FROM tb_delivery_plan a
		LEFT JOIN tb_user e ON e.customer_id=a.driver_id
		WHERE a.transport_type='发运' AND e.id=#{userId,jdbcType=INTEGER} AND a.type=0
		<if test="type != null and type == 0">
			AND DATE_FORMAT(a.delivery_plan_time,'%e %b %Y')=DATE_FORMAT(NOW(),'%e %b %Y')
		</if>
		<if test="type != null and type == 1">
			AND a.status IN(3,4)
		</if>
		<if test="type != null and type == 2">
			AND a.status IN(5,6)
		</if>
		ORDER BY a.create_time DESC
		LIMIT
		#{pageIndex,jdbcType=INTEGER},#{pageNumber,jdbcType=INTEGER} 
	</select>
	
	<!-- 司机查询出库计划总数 -->
	<select id="driverDeliveryPlanCount" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM tb_delivery_plan a
		LEFT JOIN tb_user b ON b.customer_id=a.driver_id
		WHERE a.transport_type='发运' AND b.id=#{userId,jdbcType=INTEGER} AND a.type=0 
		<if test="type != null and type == 0">
			AND DATE_FORMAT(a.delivery_plan_time,'%e %b %Y')=DATE_FORMAT(NOW(),'%e %b %Y')
		</if>
		<if test="type != null and type == 1">
			AND a.status IN(3,4)
		</if>
		<if test="type != null and type == 2">
			AND a.status IN(5,6)
		</if>
	</select>
	
	<!-- 司机查询出库计划终点 -->
	<select id="driverDeliveryPlanPoint" resultType="java.lang.String">
		SELECT a.customer FROM tb_delivery_plan a
		WHERE a.parent_id=#{deliveryId,jdbcType=INTEGER}
	</select>
	
	<!-- 经销商查询所有子出库计划单 -->
	<select id="selectAllIncomeVehicleCount" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM tb_delivery_plan
		WHERE consignee_id = (SELECT id FROM tb_consignee WHERE user_id=#{userId,jdbcType=INTEGER}) AND STATUS IN (2,3,4)
	</select>
	
	<!-- 更新出库几乎阿丹为出库计划单 -->
	<update id="updateDeliveryPlanType" parameterType="java.util.Map">
		update tb_delivery_plan
		<set>
		<trim suffixOverrides=",">
		<if test="type != null and type != '' ">
				type = #{type,jdbcType=INTEGER},
		</if>
		<if test="consigneeId != null and consigneeId != '' ">
				consignee_id = #{consigneeId,jdbcType=INTEGER},
		</if>
		</trim>
		</set>
		WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	<!-- 更新出库几乎阿丹为出库计划单 -->
	<update id="updateDeliveryPlanStruts" parameterType="java.util.Map">
		update tb_delivery_plan 
			<set>
			<trim suffixOverrides=",">
				<if test=" status != null and status!= '' ">
					status = #{status,jdbcType=INTEGER},
				</if>
				<if test=" shipNo != null and shipNo != ''  ">
					ship_no = #{shipNo,jdbcType=VARCHAR},
				</if>
			</trim>
			</set>
		 WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	<update id="updateDeliveryPlanStrutsTime" parameterType="java.util.Map">
		update tb_delivery_plan 
			<set>
			<trim suffixOverrides=",">
				<if test=" status != null and status!= '' ">
					status = #{status,jdbcType=INTEGER},
				</if>
				<if test=" shipNo != null and shipNo != ''  ">
					ship_no = #{shipNo,jdbcType=VARCHAR},
				</if>
				<if test=" deliveryTime != null">
					delivery_time = #{deliveryTime,jdbcType=TIMESTAMP},
				</if>
			</trim>
			</set>
		 WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	<!-- 经销商查询待收货所有子出库计划单 -->
	<select id="selectAllDeliveryPlanCount" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM tb_delivery_plan
		WHERE parent_id = (SELECT parent_id FROM tb_delivery_plan WHERE id=#{deliveryId,jdbcType=INTEGER}) AND STATUS = 3
	</select>
	
	<!-- 经销商查询待收货所有子出库计划单 -->
	<select id="selectAllPlanCount" resultType="java.lang.Integer">
		SELECT COUNT(1) FROM tb_delivery_plan
		WHERE parent_id = (SELECT parent_id FROM tb_delivery_plan WHERE id=#{deliveryId,jdbcType=INTEGER}) AND STATUS = 4
	</select>
	
	<!-- 经销商查询待收货所有子出库计划单 -->
	<select id="selectFatherDeliveryPlanId" resultType="java.lang.Integer">
		SELECT parent_id FROM tb_delivery_plan WHERE id=#{deliveryId,jdbcType=INTEGER}
	</select>
	
	<update id="updateDeliveryPlanRoutingStatus" parameterType="java.util.Map">
		update tb_delivery_plan set routing_status = #{routingStatus,jdbcType=INTEGER} WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	<update id="updateDeliveryPlanIdentityCardStatus" parameterType="java.util.Map">
		update tb_delivery_plan set identity_card_status = #{identityCardStatus,jdbcType=INTEGER} WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	<update id="updateDeliveryPlanIdentityCardPath" parameterType="java.util.Map">
		update tb_delivery_plan set identity_card_picture_path = #{path,jdbcType=VARCHAR} WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	<update id="updateIdentityCardStatus" parameterType="com.anji.allways.business.dto.DeliveryPlanDTO">
		update tb_delivery_plan
		<set>
			<trim suffixOverrides=",">
				<if test=" identityCardStatus != null and  identityCardStatus !=0 ">
					identity_card_status = #{identityCardStatus,jdbcType=INTEGER},
				</if>
				<if test=" checkComment != null and  checkComment !='' ">
					check_comment = #{checkComment,jdbcType=VARCHAR},
				</if>
				<if test=" updateUser != null and  updateUser !=0 ">
					update_user = #{updateUser,jdbcType=INTEGER},
				</if>
				<if test=" updateTime != null">
					update_time = #{updateTime,jdbcType=VARCHAR},
				</if>
				<if test=" keyIsTaken != null and  keyIsTaken !=0 ">
					keyIsTaken = #{keyIsTaken,jdbcType=INTEGER},
				</if>
				<if test=" selfpickerPicturePath != null and  selfpickerPicturePath !='' ">
					selfpicker_picture_path = #{selfpickerPicturePath,jdbcType=VARCHAR},
				</if>
				<if test=" shipNo != null and  shipNo !='' ">
					ship_no = #{shipNo,jdbcType=VARCHAR},
				</if>
			</trim>
		</set>
			WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	<update id="updateIdentityCardStatusForTwo" parameterType="java.util.Map">
		update tb_delivery_plan	set keyIsTaken = #{keyIsTaken,jdbcType=INTEGER} WHERE id=#{id,jdbcType=INTEGER}
	</update>
	
	
	<update id="updatekeyIsTakenById" parameterType="com.anji.allways.business.dto.DeliveryPlanDTO">
		update tb_delivery_plan 
		set 
			keyIsTaken = #{keyIsTaken,jdbcType=INTEGER} ,
			update_user = #{updateUser,jdbcType=INTEGER},
			update_time = #{updateTime,jdbcType=VARCHAR}
		where 
		(parent_id =#{id,jdbcType=INTEGER} or id = #{id,jdbcType=INTEGER})
		AND status !=6
		
	</update>
	
	<select id="printDeliveryPlanVOMapFy" resultMap="deliveryPlanVOMapPrintFy">
		SELECT
			plan.id,
			plan.NO,
			plan.ship_no,
			plan.delivery_time,
			truck.transport_company_name,
			truck.truck_number,
			truck.NAME driver_name,
			o.destination,
			o.customer,
			nee.NAME consignee_name,
			nee.mobile consignee_mobile
		FROM
			tb_delivery_plan plan
		LEFT JOIN tb_order o ON plan.id = o.delivery_plan_id
		LEFT JOIN tb_truck_driver truck ON plan.driver_id = truck.id
		LEFT JOIN tb_consignee nee ON plan.consignee_id = nee.id
		WHERE
			plan.id = #{id,jdbcType=INTEGER}
		GROUP BY
			plan.id,
			plan.NO,
			plan.ship_no,
			plan.delivery_time,
			truck.transport_company_name,
			truck.truck_number,
			truck.NAME,
			o.destination,
			o.customer,
			nee.NAME,
			nee.mobile

	</select>
	
	<select id="queryDeliveryPlanForExport" resultType="java.util.LinkedHashMap" parameterType="java.util.Map" >
		SELECT
			IFNULL(plan. NO, '') AS '出库计划单号',
			IFNULL(DATE_FORMAT(plan.create_time,'%Y-%m-%d %H:%i:%S'), '') AS '创建时间',
			IFNULL(driver.truck_number, '') AS '车牌号',
			IFNULL(plan.warehouse_name, '') AS '仓库名',
			IFNULL(plan.pickup_plan_time, '') AS '计划自提时间',
			IFNULL(plan.delivery_time, '') AS '出库时间',
			IFNULL(plan.ship_no, '') AS '交接单号',
			IFNULL(plan.operator, '') AS '操作人',
			IFNULL(plan.transport_type, '') AS '出库类型',
			(
				SELECT
					count(1)
				FROM
					tb_order o
				WHERE
					o.delivery_plan_id = plan.id
			) AS '车辆数',
			(
				CASE
				WHEN plan. STATUS = 2 THEN
					'待自提'
				WHEN plan. STATUS = 3 THEN
					'待出库'
				WHEN plan. STATUS = 4 THEN
					'待收货'
				WHEN plan. STATUS = 5 THEN
					'已完成'
				WHEN plan. STATUS = 6 THEN
					'已取消'
				ELSE '' 
				END
			) AS '状态'
		FROM
			tb_delivery_plan plan
		LEFT JOIN tb_truck_driver driver ON plan.driver_id = driver.id
		WHERE
			1 = 1
			<if test="type != null">
				and plan.type = #{type}
			</if>
			<include refid="Base_Where_List"/>
			order by plan.create_time DESC
	</select>
	
	<select id="selectMessageInfo" resultMap="BaseResultMap">
		SELECT
		    p.no,
			w.contactor_mobile,
			p.warehouse_name,
			nee.mobile
		FROM
			tb_delivery_plan p
		INNER JOIN tb_warehouse w ON p.warehouse_id = w.id
		INNER JOIN tb_consignee nee ON p.consignee_id = nee.id
		WHERE
			p.id =#{id,jdbcType=INTEGER}
	</select>
	
	<select id="selectOrderReceiveTime" resultType="java.util.Date" parameterType="java.lang.Integer">
		SELECT
		receive_time FROM tb_order
		WHERE delivery_plan_id=#{id,jdbcType=INTEGER}
		LIMIT 1
	</select>
	
	<select id="selectDeliveryPlanManage" parameterType="com.anji.allways.business.dto.DeliveryPlanDTO" resultMap="BaseResultMap">
		SELECT
				plan.id,
				plan.NO,
				plan.create_time,
				plan.warehouse_name,
				plan.pickup_plan_time,
				plan.delivery_plan_time,
				plan.delivery_time,
				plan.ship_no,
				plan.operator,
				plan.identity_card_status,
				plan.keyIsTaken,
				driver.NAME driverName,
				driver.mobile driverMobile,
				driver.transport_company_name,
				driver.truck_number,
				plan.delivery_type,
				plan.STATUS,
				plan.warehouse_id,
				plan.transport_type,
				(CASE
				WHEN plan.transport_type = '自提' THEN
				(
					SELECT	count(1)	FROM	tb_order o	WHERE	o.delivery_plan_id = plan.id
				)
				WHEN plan.transport_type = '发运' THEN
				(
					SELECT	count(1)	FROM	tb_order o
					WHERE
						o.delivery_plan_id IN (
							SELECT
								plan1.id
							FROM
								tb_delivery_plan plan1
							WHERE
								plan1.parent_id = plan.id
						)
				)
			END) carsNum,
			(
					CASE
					WHEN plan.STATUS = 2 THEN
						'待自提'
					WHEN plan.STATUS = 3 THEN
						'待出库'
					WHEN plan.STATUS = 4 THEN
						'待收货'
					WHEN plan.STATUS = 5 THEN
						'已完成'
					WHEN plan.STATUS = 6 THEN
						'已取消'
					END
				) STATUS_NAME
			FROM
				tb_delivery_plan plan
			LEFT JOIN tb_truck_driver driver ON plan.driver_id = driver.id
			WHERE
				1 = 1
				AND (CASE
				WHEN plan.transport_type = '自提' THEN
					type = 1
				WHEN plan.transport_type = '发运' THEN
					type = 0
				END)
				<include refid="Base_Where_List"/>
			ORDER BY
				plan.create_time DESC	
			<if test="dbIndex != null and dbNumber != null">
     			limit #{dbIndex},#{dbNumber}
   			</if>
	</select>
	
	<select id="selectDeliveryPlanCountForTwo" parameterType="com.anji.allways.business.dto.DeliveryPlanDTO"
		resultType="java.lang.Integer">
	select count(1)
		FROM
			tb_delivery_plan plan
				LEFT JOIN tb_truck_driver driver ON plan.driver_id = driver.id
		WHERE 
		    1=1
		    <if test="type != null">
				and plan.type = #{type}
			</if>
		    <include refid="Base_Where_List"/>
	</select>
	
	<select id="queryDeliveryPlanForExportForTwo" resultType="java.util.LinkedHashMap" parameterType="java.util.Map" >
			SELECT
					IFNULL(plan. NO, '') AS '出库计划单号',
					IFNULL(DATE_FORMAT(plan.create_time,'%Y-%m-%d %H:%i:%S'), '') AS '创建时间',
					IFNULL(driver.truck_number, '') AS '驳运车牌',
					IFNULL(plan.warehouse_name, '') AS '仓库',
					IFNULL(plan.pickup_plan_time, '') AS '计划自提时间',
					IFNULL(plan.delivery_plan_time, '') AS '计划发运时间',
					IFNULL(plan.delivery_time, '') AS '出库时间',
					IFNULL(plan.ship_no, '') AS '交接单号',
					IFNULL(plan.operator, '') AS '操作人',
					IFNULL(plan.transport_type, '') AS '出库类型',
					(CASE
						WHEN plan.transport_type = '自提' THEN
						(
							SELECT	count(1)	FROM	tb_order o	WHERE	o.delivery_plan_id = plan.id
						)
						WHEN plan.transport_type = '发运' THEN
						(
							SELECT	count(1)	FROM	tb_order o
							WHERE
								o.delivery_plan_id IN (
									SELECT
										plan1.id
									FROM
										tb_delivery_plan plan1
									WHERE
										plan1.parent_id = plan.id
								)
						)
					END) AS '车辆数',
				(
						CASE
						WHEN plan.STATUS = 2 THEN
							'待自提'
						WHEN plan.STATUS = 3 THEN
							'待出库'
						WHEN plan.STATUS = 4 THEN
							'待收货'
						WHEN plan.STATUS = 5 THEN
							'已完成'
						WHEN plan.STATUS = 6 THEN
							'已取消'
						ELSE '' 
						END
					) AS '状态'
				FROM
					tb_delivery_plan plan
				LEFT JOIN tb_truck_driver driver ON plan.driver_id = driver.id
				WHERE
					1 = 1
					AND (CASE
					WHEN plan.transport_type = '自提' THEN
						type = 1
					WHEN plan.transport_type = '发运' THEN
						type = 0
					END)
					<include refid="Base_Where_List"/>
				ORDER BY
					plan.create_time DESC	
	</select>


</mapper>